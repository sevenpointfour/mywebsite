<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Content Editor</title>
    <!-- 1. Add the TinyMCE script. You can get a free API key from tiny.cloud -->
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 1rem 2rem; background-color: #f4f4f9; color: #333; }
        h1 { color: #1a1a2e; }
        #saveButton { font-size: 1rem; padding: 0.5rem 1.5rem; margin-top: 1rem; cursor: pointer; background-color: #1a1a2e; color: white; border: none; border-radius: 5px; }
        #saveButton:hover { background-color: #162447; }
        .status { margin-top: 1rem; font-style: italic; color: #555; }
    </style>
</head>
<body>

    <h1>Edit Page Content</h1>
    
    <!-- 2. This is where the editor will be rendered. -->
    <textarea id="myeditor">Loading content...</textarea>

    <button id="saveButton">Save Content</button>
    <div id="status" class="status"></div>

    <script>
        // 3. Initialize TinyMCE
        tinymce.init({
            selector: 'textarea#myeditor',
            plugins: 'code table lists image link media wordcount help',
            toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | indent outdent | bullist numlist | code | table | image link media | help',
            height: 500,
            // This setup function runs when the editor is ready
            setup: function(editor) {
                editor.on('init', function() {
                    // Load content when the editor is initialized
                    loadContent();
                });
            }
        });

        const saveButton = document.getElementById('saveButton');
        const statusDiv = document.getElementById('status');

        // --- Helper function to get page name from URL ---
        // For example, if your URL is http://localhost:3010/admin-editor.html?page=home
        function getPageName() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('page') || 'home'; // Default to 'home' if not specified
        }

        // --- Logic to LOAD content from your server ---
        async function loadContent() {
            const pageName = getPageName();
            document.title = `Editing: ${pageName}`;
            statusDiv.textContent = `Loading content for '${pageName}'...`;

            try {
                const response = await fetch(`/api/page-content/${pageName}`);
                if (!response.ok) {
                    throw new Error(`Failed to load content. Status: ${response.status}`);
                }
                const data = await response.json();
                tinymce.get('myeditor').setContent(data.content || '');
                statusDiv.textContent = `Content for '${pageName}' loaded successfully.`;
            } catch (error) {
                console.error('Error loading content:', error);
                statusDiv.textContent = `Error: ${error.message}`;
                tinymce.get('myeditor').setContent('<p>Could not load content.</p>');
            }
        }

        // --- Logic to SAVE content to your server ---
        saveButton.addEventListener('click', async () => {
            const content = tinymce.get('myeditor').getContent();
            const pageName = getPageName();
            // Use the correct token key from your admin-login.html
            const token = localStorage.getItem('adminWebsiteToken'); 

            if (!token) {
                alert('You must be logged in to save content.');
                statusDiv.textContent = 'Error: Not logged in.';
                return;
            }

            statusDiv.textContent = `Saving content for '${pageName}'...`;

            try {
                const response = await fetch(`/api/page-content/${pageName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ content: content })
                });

                const result = await response.json();
                if (response.ok) {
                    statusDiv.textContent = result.message || 'Content saved successfully!';
                } else {
                    throw new Error(result.error || 'An unknown error occurred.');
                }
            } catch (error) {
                console.error('Error saving content:', error);
                statusDiv.textContent = `Error saving content: ${error.message}`;
            }
        });
    </script>

</body>
</html>
