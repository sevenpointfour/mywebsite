
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Medical History</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f9f9f9; color: #333; line-height: 1.6; }
        .container { max-width: 900px; margin: auto; background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); }
        h1 { color: #0056b3; text-align: center; margin-bottom: 25px; }
        h2.section-title { color: #007bff; margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        
        .history-section textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            margin-bottom: 25px; /* Increased margin */
            resize: vertical;
        }

        .medications-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .medications-table th, .medications-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left; /* Default for most cells */
            vertical-align: top;
        }
        .medications-table th { background-color: #f0f4f8; font-weight: bold; font-size: 0.9em; }
        .medications-table td input[type="text"], .medications-table td input[type="number"] /* Added number for potential future use */ {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-sizing: border-box;
            font-size: 0.9em;
        }
        .medications-table td.sr-no-column { width: 60px; text-align: center; } /* Slightly wider */
        .medications-table .action-cell { width: 90px; text-align: center; } /* Slightly wider */
        .medications-table .remove-row-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85em; /* Slightly larger */
            transition: background-color 0.2s ease;
        }
        .medications-table .remove-row-btn:hover { background-color: #c82333; }

        .add-row-btn {
            background-color: #17a2b8;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em; /* Slightly larger */
            margin-bottom: 20px;
            transition: background-color 0.2s ease;
        }
        .add-row-btn:hover { background-color: #138496; }

        .form-actions { text-align: center; margin-top: 30px; }
        .form-actions button { /* General style for buttons in form-actions */
            padding: 12px 25px; /* Increased padding for larger size */
            font-size: 1.1em;  /* Increased font size */
            border: none;
            border-radius: 8px; /* More rounded corners */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            display: block; /* Make buttons stack */
            width: 60%; /* Adjust width as needed, or use max-width */
            margin: 10px auto; /* Center buttons and add space between them */
        }

        #saveMedicalHistoryBtn {
            background-color: #28a745;
            color: white;
        }
        #saveMedicalHistoryBtn:hover { background-color: #218838; }

        #submitMedicalHistoryBtn {
            background-color: #007bff;
            color: white;
        }
        #submitMedicalHistoryBtn:hover { background-color: #0056b3; }

        #formMessage { margin-top: 20px; padding: 10px; border-radius: 4px; text-align: center; }
        .success-message { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error-message { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
    <!-- Navbar CSS (also add to other pages) -->
    <style>
        /* Navbar Styles */
        .main-navbar {
            background-color: #333;
            overflow: hidden;
            margin-bottom: 20px; /* Add some space below the navbar */
        }
        .main-navbar ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            text-align: center;
        }
        .main-navbar li {
            display: inline-block; /* Display items in a line */
        }
        .main-navbar li a {
            display: block;
            color: white;
            text-align: center;
            padding: 14px 20px;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }
        .main-navbar li a:hover {
            background-color: #555;
        }
        .main-navbar li a.active { /* Style for the active page link */
            background-color: #007bff;
        }
        /* Style for logout button in navbar */
        .main-navbar li a#logoutButton {
            background-color: #dc3545; /* Red color for logout */
            margin-left: 10px; /* Optional: add some space if it's the last item */
            border-radius: 4px; /* Optional: slightly rounded corners */
        }
        .main-navbar li a#logoutButton:hover {
            background-color: #c82333; /* Darker red on hover */
        }
    </style>
</head>
<body>
    <nav class="main-navbar">
        <ul>
            <li><a href="client-personal-details-form.html">Personal Details</a></li>
            <li><a href="client-blood-tests-form.html">Blood Tests</a></li>
            <li><a href="client-food-plan.html">Food Plan</a></li>
            <li><a href="client-medical-history-form.html" class="active">Medical History</a></li>
            <li><a href="#" id="logoutButton">Logout</a></li>
        </ul>
    </nav>
    <div class="container">
        <h1>Client Medical History</h1>

        <form id="medicalHistoryForm">
            <div class="history-section">
                <h2 class="section-title">Self Medical History</h2>
                <textarea name="self_medical_history" placeholder="Describe personal medical history, past illnesses, surgeries, allergies, etc."></textarea>
            </div>

            <div class="history-section">
                <h2 class="section-title">Medical History of Family</h2>
                <textarea name="family_medical_history" placeholder="Describe medical history of immediate family members (parents, siblings), noting any hereditary conditions."></textarea>
            </div>

            <h2 class="section-title">Details of Medications, if any</h2>
            <table class="medications-table">
                <thead>
                    <tr>
                        <th class="sr-no-column">Sr No.</th>
                        <th>Diagnosis</th>
                        <th>Medicines Name</th>
                        <th>Power</th>
                        <th>Time</th>
                        <th>Since when</th>
                        <th class="action-cell">Action</th>
                    </tr>
                </thead>
                <tbody id="medicationsTableBody">
                    <!-- Medication rows will be added here by JavaScript -->
                </tbody>
            </table>
            <button type="button" class="add-row-btn" id="addMedicationBtn">+ Add Medication</button>

            <div class="form-actions">
                <button type="button" id="saveMedicalHistoryBtn">Save Medical History</button>
                <button type="button" id="submitMedicalHistoryBtn">Submit Final History</button>
            </div>
            <div style="text-align: center; margin-top: 15px; font-size: 0.9em; color: #555;">  
                <p><strong>Note:</strong> The "Save Medical History" button allows you to save your progress and return later.
                Once you click "Submit Final History", the data will be finalized and you may not be able to edit it without specific permission from the Admin.</p>
            </div>
        </form>
        <div id="formMessage"></div>
    </div>
    <script>
        // Logout functionality
        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('clientToken');
                window.location.href = '/client-login.html';
            });
        }
        let medicationSrNo = 0;

        function addMedicationRow() {
            medicationSrNo++;
            const tableBody = document.getElementById('medicationsTableBody');
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
                <td class="sr-no-column">${medicationSrNo}</td>
                <td><input type="text" name="med_diagnosis_${medicationSrNo}" placeholder="e.g., Hypertension"></td>
                <td><input type="text" name="med_name_${medicationSrNo}" placeholder="e.g., Amlodipine"></td>
                <td><input type="text" name="med_power_${medicationSrNo}" placeholder="e.g., 5mg"></td>
                <td><input type="text" name="med_time_${medicationSrNo}" placeholder="e.g., Morning"></td>
                <td><input type="text" name="med_since_${medicationSrNo}" placeholder="e.g., 2 years"></td>
                <td class="action-cell"><button type="button" class="remove-row-btn" onclick="removeMedicationRow(this)">Remove</button></td>
            `;
        }

        function removeMedicationRow(button) {
            const row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
            // Note: If you remove rows, the medicationSrNo logic for submission might need adjustment
            // if you don't re-number the displayed Sr.No. The current submission logic
            // tries to read the Sr.No. from the table cell.
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchAndPopulateMedicalHistory();
            addMedicationRow(); // Add one row by default

            const addMedBtn = document.getElementById('addMedicationBtn');
            if (addMedBtn) {
                addMedBtn.addEventListener('click', addMedicationRow);
            }
        });

        // Get the form element once
        const medicalHistoryFormElement = document.getElementById('medicalHistoryForm');

        // Get button elements once
        const saveBtn = document.getElementById('saveMedicalHistoryBtn');
        const submitBtn = document.getElementById('submitMedicalHistoryBtn');
        const addMedicationBtnElement = document.getElementById('addMedicationBtn');
        async function handleFormSubmission(event, isFinalSubmission) {
            event.preventDefault();
            const formMessage = document.getElementById('formMessage');
            formMessage.textContent = '';
            formMessage.className = '';

            const formData = new FormData(this); // 'this' refers to medicalHistoryFormElement due to .call()
            const dataToSend = {
                self_medical_history: formData.get('self_medical_history'),
                family_medical_history: formData.get('family_medical_history'),
                medications: [],
                is_final_submission: isFinalSubmission
            };
            
            const medicationRows = document.getElementById('medicationsTableBody').rows;
            for (let i = 0; i < medicationRows.length; i++) {
                const row = medicationRows[i];
                // Get the serial number directly from the first cell of the current row
                const currentMedicationRowNumber = row.cells[0].textContent.trim();
                
                const diagnosis = formData.get(`med_diagnosis_${currentMedicationRowNumber}`);
                const name = formData.get(`med_name_${currentMedicationRowNumber}`);
                
                if (name && name.trim() !== '') {
                    dataToSend.medications.push({
                        diagnosis: diagnosis,
                        name: name,
                        power: formData.get(`med_power_${currentMedicationRowNumber}`),
                        time: formData.get(`med_time_${currentMedicationRowNumber}`),
                        since: formData.get(`med_since_${currentMedicationRowNumber}`)
                    });
                }
            }

            console.log('Medical history data to be submitted:', JSON.stringify(dataToSend, null, 2));
            formMessage.textContent = 'Processing...';
            formMessage.className = 'info-message';

            const token = localStorage.getItem('clientToken');
            if (!token) {
                formMessage.textContent = 'Error: Authentication token not found. Please log in again.';
                formMessage.className = 'error-message';
                return;
            }

            try {
                const response = await fetch('/api/client/medical-history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(dataToSend)
                });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || `HTTP error! status: ${response.status}`);
                }
                formMessage.textContent = result.message || `Medical history ${isFinalSubmission ? 'submitted' : 'saved'} successfully!`;
                formMessage.className = 'success-message';
                hasUnsavedChanges = false; 
            } catch (error) {
                formMessage.textContent = 'Error: ' + error.message;
                formMessage.className = 'error-message';
                console.error('Submission error:', error);
            }
        }

        function setFormReadOnly(isReadOnly) {
            const formElements = medicalHistoryFormElement.elements;
            for (let i = 0; i < formElements.length; i++) {
                // Don't disable the logout button if it were part of this form
                if (formElements[i].type !== 'button' || 
                    (formElements[i].id !== 'saveMedicalHistoryBtn' && formElements[i].id !== 'submitMedicalHistoryBtn' && formElements[i].id !== 'addMedicationBtn')) {
                    formElements[i].disabled = isReadOnly;
                }
            }

            if (saveBtn) saveBtn.disabled = isReadOnly;
            if (submitBtn) submitBtn.disabled = isReadOnly;
            if (addMedicationBtnElement) addMedicationBtnElement.disabled = isReadOnly;

            // Also disable remove buttons in medication rows
            document.querySelectorAll('.remove-row-btn').forEach(btn => {
                btn.disabled = isReadOnly;
            });
        }

        document.getElementById('saveMedicalHistoryBtn').addEventListener('click', function(event) {
            handleFormSubmission.call(medicalHistoryFormElement, event, false);
        });

        document.getElementById('submitMedicalHistoryBtn').addEventListener('click', function(event) {
            if (confirm("Are you sure you want to submit the final medical history? You may not be able to edit it later without admin permission.")) {
                handleFormSubmission.call(medicalHistoryFormElement, event, true);
            }
        });

        async function fetchAndPopulateMedicalHistory() {
            const formMessage = document.getElementById('formMessage');
            const token = localStorage.getItem('clientToken');
            if (!token) {
                console.log('No client token found, cannot fetch medical history.');
                return;
            }

            try {
                const response = await fetch('/api/client/medical-history/latest', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (!response.ok) {
                    if (response.status === 404 || (data.message && data.message.includes("No medical history found"))) {
                        console.log('No existing medical history found to populate.');
                        return; 
                    }
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                
                if (data.message && data.message.includes("No medical history found")) {
                     console.log('No existing medical history found to populate.');
                     return;
                }

                document.querySelector('textarea[name="self_medical_history"]').value = data.self_medical_history || '';
                document.querySelector('textarea[name="family_medical_history"]').value = data.family_medical_history || '';

                if (data.is_finalized) {
                    setFormReadOnly(true);
                    formMessage.textContent = 'Your medical history has been finalized and cannot be edited. Please contact support if changes are needed.';
                    formMessage.className = 'info-message';
                    // No need to populate medications if form is read-only and we are just showing a message.
                    // However, if you want to show the finalized data, you'd continue to populate.
                } else {
                    setFormReadOnly(false); // Ensure form is editable if not finalized
                }

                const tableBody = document.getElementById('medicationsTableBody');
                tableBody.innerHTML = ''; 
                medicationSrNo = 0; // Reset serial number for populating

                if (data.medications && data.medications.length > 0) {
                    data.medications.forEach(med => {
                        addMedicationRow(); // This increments medicationSrNo and adds a row
                        // The name attributes in the new row will use the new medicationSrNo
                        document.querySelector(`input[name="med_diagnosis_${medicationSrNo}"]`).value = med.diagnosis || '';
                        document.querySelector(`input[name="med_name_${medicationSrNo}"]`).value = med.medicine_name || '';
                        document.querySelector(`input[name="med_power_${medicationSrNo}"]`).value = med.power || '';
                        document.querySelector(`input[name="med_time_${medicationSrNo}"]`).value = med.timing || '';
                        document.querySelector(`input[name="med_since_${medicationSrNo}"]`).value = med.since_when || '';
                    });
                } else {
                    addMedicationRow(); 
                }

                if (!data.is_finalized) { // Only show "loaded" if not finalized, as finalized has its own message
                    formMessage.textContent = 'Previously saved data loaded.';
                    formMessage.className = 'info-message';
                }
            } catch (error) {
                console.error('Error fetching medical history:', error);
                formMessage.textContent = 'Error: Could not load previous medical history. ' + error.message;
                formMessage.className = 'error-message';
            }
        }

        let hasUnsavedChanges = false;
        const form = document.getElementById('medicalHistoryForm');

        form.addEventListener('input', function(event) {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                hasUnsavedChanges = true;
            }
        });

        window.addEventListener('beforeunload', function (e) {
            if (hasUnsavedChanges) {
                e.preventDefault(); 
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?'; 
                return 'You have unsaved changes. Are you sure you want to leave?'; 
            }
        });
    </script>

 
</body>
</html>
