 <!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Nutritionist Dashboard</title>
     <script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/classic/ckeditor.js"></script>
     <link rel="stylesheet" href="admin_style.css">
 </head>
 <body>
     <header class="navbar">
         <div class="navbar-brand">Nutritionist Dashboard</div>
         <nav class="navbar-links">
             <ul>
                 <li><a href="#assigned-clients">My Clients</a></li>
                 <li><button id="logoutButton" class="nav-logout-btn">Logout</button></li>
             </ul>
         </nav>
     </header>
 
     <main class="admin-container">
         <section id="assigned-clients" class="management-section">
             <h2>Search My Assigned Clients</h2>
             <div class="search-container" style="margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px; background-color: #fdfdfd;">
                 <form id="searchMyClientsForm" style="display: flex; flex-wrap: wrap; gap: 10px;">
                     <div class="form-group" style="flex-grow: 1; min-width: 120px;">
                         <label for="search_client_id_nutri" style="flex-basis: auto; margin-bottom: 5px;">Client ID:</label>
                         <input type="text" id="search_client_id_nutri" name="client_id" style="width: 100%;">
                     </div>
                     <div class="form-group" style="flex-grow: 1; min-width: 150px;">
                         <label for="search_first_name_nutri" style="flex-basis: auto; margin-bottom: 5px;">First Name:</label>
                         <input type="text" id="search_first_name_nutri" name="first_name" style="width: 100%;">
                     </div>
                     <div class="form-group" style="flex-grow: 1; min-width: 150px;">
                         <label for="search_last_name_nutri" style="flex-basis: auto; margin-bottom: 5px;">Last Name:</label>
                         <input type="text" id="search_last_name_nutri" name="last_name" style="width: 100%;">
                     </div>
                     <div class="form-group" style="flex-grow: 1; min-width: 180px;">
                         <label for="search_email_nutri" style="flex-basis: auto; margin-bottom: 5px;">Email:</label>
                         <input type="email" id="search_email_nutri" name="email" style="width: 100%;">
                     </div>
                     <button type="submit" class="submit-btn" style="align-self: flex-end;">Search</button>
                     <button type="button" id="clearSearchMyClientsBtn" class="submit-btn" style="align-self: flex-end; background-color: #6c757d;">Clear</button>
                 </form>
             </div>
             <h2>My Assigned Clients</h2>
             <table id="clientsTable">
                 <thead>
                     <tr>
                         <th>ID</th>
                         <th>Name</th>
                         <th>Email</th>
                         <th>Mobile</th>
                         <th>Actions</th>
                     </tr>
                 </thead>
                 <tbody id="clientsTableBody">
                     <!-- Client rows will be populated by JavaScript -->
                 </tbody>
             </table>
             <div id="listClientsMessage" class="message-area"></div>
         </section>
     </main>
 
     <!-- Modal for Viewing Client Biodata -->
     <div id="viewClientBiodataModal" class="modal" style="display: none;">
         <div class="modal-content" style="max-width: 800px;">
             <span class="close-btn" id="closeViewClientBiodataModalBtn">&times;</span>
             <h3 id="viewClientBiodataModalTitle">Client Personal Details</h3>
             <div id="viewClientBiodataContent" class="read-only-grid-display"></div>
             <div id="viewClientBiodataMessage" class="message-area"></div>
         </div>
     </div>
 
     <!-- Modal for Viewing Client Medical History -->
     <div id="viewClientMedicalHistoryModal" class="modal" style="display: none;">
         <div class="modal-content" style="max-width: 800px;">
             <span class="close-btn" id="closeViewClientMedicalHistoryModalBtn">&times;</span>
             <h3 id="viewClientMedicalHistoryModalTitle">Client Medical History</h3>
             <h4>Self Medical History</h4>
             <div id="viewSelfMedicalHistory" class="read-only-display"></div>
             <h4>Family Medical History</h4>
             <div id="viewFamilyMedicalHistory" class="read-only-display"></div>
             <h4>Medications</h4>
             <table class="medications-table-readonly">
                 <thead>
                     <tr>
                         <th>Diagnosis</th>
                         <th>Medicine Name</th>
                         <th>Power</th>
                         <th>Timing</th>
                         <th>Since When</th>
                     </tr>
                 </thead>
                 <tbody id="viewClientMedicationsTableBody"></tbody>
             </table>
             <div id="viewClientMedicalHistoryMessage" class="message-area"></div>
         </div>
     </div>
 
     <!-- Modal for Viewing Client Blood Tests -->
     <div id="viewClientBloodTestsModal" class="modal" style="display: none;">
         <div class="modal-content" style="max-width: 950px;">
             <span class="close-btn" id="closeViewClientBloodTestsModalBtn">&times;</span>
             <h3 id="viewClientBloodTestsModalTitle">Client Blood Test Results</h3>
             <div id="viewClientBloodTestReportDates" style="margin-bottom: 15px; font-weight: bold;"></div>
             <div id="viewClientBloodTestsTableContainer" class="test-table"></div>
             <div id="viewClientBloodTestsMessage" class="message-area"></div>
         </div>
     </div>
 
     <!-- Modal for Client Food Plan (Editable by Nutritionist - No CKEditor for hourly) -->
     <div id="clientFoodPlanModal" class="modal" style="display: none;">
         <div class="modal-content" style="max-width: 900px;">
             <span class="close-btn" id="closeClientFoodPlanModalBtn">&times;</span>
             <h3 id="clientFoodPlanModalTitle">Manage Client Food Plan</h3>
             <form id="clientFoodPlanEditForm">
                 <input type="hidden" id="editing_client_id_for_food_plan">
                 <h4>Hourly Food Plan</h4>
                 <table class="hourly-plan-table">
                     <thead>
                         <tr>
                             <th class="time-column">Time</th>
                             <th>Present Intake</th>
                             <th>Proposed Structure</th>
                             <th>Additional Points</th>
                         </tr>
                     </thead>
                     <tbody id="clientFoodPlanHourlyTableBody"></tbody>
                 </table>
                 <div class="form-group" style="margin-top: 20px;">
                     <label for="clientFoodPlanPersonalRecommendations">Additional Personal Recommendations (for this client):</label>
                     <textarea id="clientFoodPlanPersonalRecommendations" name="additional_personal_recommendations" rows="5"></textarea>
                 </div>
                 <div class="form-group" style="margin-top: 20px;">
                     <label>General Admin Recommendations (for context - read-only):</label>
                     <div id="clientFoodPlanGeneralAdminRecommendationsDisplay" class="read-only-display">Loading...</div>
                 </div>
                 <button type="submit" class="submit-btn">Save Client Food Plan</button>
             </form>
             <div id="clientFoodPlanMessage" class="message-area"></div>
         </div>
     </div>
 
     <script>
         const staffToken = localStorage.getItem('staffToken');
         if (!staffToken) {
             window.location.href = '/staff-login.html';
         }
         // Verify role from token if stored, or redirect if not nutritionist
         try {
             const decodedToken = JSON.parse(atob(staffToken.split('.')[1]));
             if (decodedToken.role !== 'nutritionist') {
                 alert('Access denied. Not a nutritionist.');
                 localStorage.removeItem('staffToken');
                 window.location.href = '/staff-login.html';
             }
         } catch (e) {
             console.error("Error decoding token:", e);
             localStorage.removeItem('staffToken');
             window.location.href = '/staff-login.html';
         }
 
 
         const clientsTableBody = document.getElementById('clientsTableBody');
         const listClientsMessageDiv = document.getElementById('listClientsMessage');
         const logoutButton = document.getElementById('logoutButton');
         const searchMyClientsForm = document.getElementById('searchMyClientsForm');
         const clearSearchMyClientsBtn = document.getElementById('clearSearchMyClientsBtn');
 
         // Modal Elements
         const viewClientBiodataModal = document.getElementById('viewClientBiodataModal');
         const viewClientBiodataModalTitle = document.getElementById('viewClientBiodataModalTitle');
         const viewClientBiodataContentDiv = document.getElementById('viewClientBiodataContent');
         const viewClientBiodataMessageDiv = document.getElementById('viewClientBiodataMessage');
 
         const viewClientMedicalHistoryModal = document.getElementById('viewClientMedicalHistoryModal');
         const viewClientMedicalHistoryModalTitle = document.getElementById('viewClientMedicalHistoryModalTitle');
         const viewSelfMedicalHistoryDiv = document.getElementById('viewSelfMedicalHistory');
         const viewFamilyMedicalHistoryDiv = document.getElementById('viewFamilyMedicalHistory');
         const viewClientMedicationsTableBody = document.getElementById('viewClientMedicationsTableBody');
         const viewClientMedicalHistoryMessageDiv = document.getElementById('viewClientMedicalHistoryMessage');
 
         const viewClientBloodTestsModal = document.getElementById('viewClientBloodTestsModal');
         const viewClientBloodTestsModalTitle = document.getElementById('viewClientBloodTestsModalTitle');
         const viewClientBloodTestReportDatesDiv = document.getElementById('viewClientBloodTestReportDates');
         const viewClientBloodTestsTableContainer = document.getElementById('viewClientBloodTestsTableContainer');
         const viewClientBloodTestsMessageDiv = document.getElementById('viewClientBloodTestsMessage');
 
         const clientFoodPlanModal = document.getElementById('clientFoodPlanModal');
         const clientFoodPlanModalTitle = document.getElementById('clientFoodPlanModalTitle');
         const clientFoodPlanEditForm = document.getElementById('clientFoodPlanEditForm');
         const clientFoodPlanHourlyTableBody = document.getElementById('clientFoodPlanHourlyTableBody');
         const clientFoodPlanPersonalRecommendationsTextarea = document.getElementById('clientFoodPlanPersonalRecommendations');
         const clientFoodPlanGeneralAdminRecommendationsDisplay = document.getElementById('clientFoodPlanGeneralAdminRecommendationsDisplay');
         const clientFoodPlanMessageDiv = document.getElementById('clientFoodPlanMessage');
         // let clientFoodPlanEditors = {}; // CKEditor no longer used for hourly plan on this page
 
         const bloodTestDefinitions = {
             cbc: {
                 title: 'CBC',
                 tests: [
                     { key: 'hemoglobin', name: 'HEMOGLOBIN', range: 'M= 13.5-18 GM/DL; F=12-16.8 GM/DL' },
                     { key: 'total_wbc', name: 'TOTAL WBC', range: '4000-11000 /CMM' },
                     { key: 'total_rbc', name: 'TOTAL RBC', range: '4.5-6 MIL/CMM' },
                     { key: 'platelet', name: 'PLATELET', range: '150000-450000 /CMM' },
                     { key: 'pcv', name: 'PCV', range: 'M - 40 TO 50 , F - 36 TO 46' },
                     { key: 'mcv', name: 'MCV', range: '83 TO 101 FL' },
                     { key: 'mch', name: 'MCH', range: '27-32 PG' },
                     { key: 'mchc', name: 'MCHC', range: '32-36% G/DL' },
                     { key: 'rdw', name: 'RDW', range: '11.5-14%' },
                     { key: 'eosinophils', name: 'EOSINOPHILS', range: '0 - 6' }
                 ]
             },
             diabetes: {
                 title: 'DIABETES INDICATOR',
                 tests: [
                     { key: 'fasting_glucose', name: 'FASTING BLOOD GLUCOSE', range: '70-110 MG/DL' },
                     { key: 'fasting_insulin', name: 'FASTING INSULIN', range: '2.6-37.6 MICRO U/ML' },
                     { key: 'hba1c_hplc', name: 'HbA 1 C (HPLC)', range: '&lt;/= 6.0 % OF TOTAL Hb' },
                     { key: 'hba1c_ifcc', name: 'HbA 1 C (IFCC) (HPLC)', range: '&lt;/= 42MMOL/MOL' },
                     { key: 'avg_plasma_glucose', name: 'AVG. PLASMA GLUCOSE OF LAST 3 MONTHS (CALC)', range: '80-140 MG/DL' }
                 ]
             },
             kft: {
                 title: 'KIDNEY FUNCTION TEST',
                 tests: [
                     { key: 'uric_acid', name: 'URIC ACID', range: 'M-3.5 TO 7.2, F - 2.6 TO 6' },
                     { key: 'bun', name: 'BLOOD UREA NITROGEN ( BUN)', range: 'MG/DL 7.9 TO 20' },
                     { key: 's_creatinine', name: 'S. CREATININE', range: 'M= 0.4-1.4 MG/DL; F= 0.2-1.2 MG/DL' },
                     { key: 'bun_creatinine_ratio', name: 'BUN / S CREATININE RATIO', range: '9.1 TO 23.1' },
                     { key: 'sodium', name: 'SODIUM', range: 'MMOL/L 136-146' },
                     { key: 'chloride', name: 'CHLORIDE', range: 'MMOL/L 98 - 106' },
                     { key: 'egfr', name: 'ESTIMATED GLOMERULAR FILTERATION RATE', range: '&gt;90, 60-90,45-59,30 -44, 15,29' }
                 ]
             },
             lft: {
                 title: 'LIVER FUNCTION TEST (LFT)',
                 tests: [
                     { key: 'bilirubin_total', name: 'S. BILIRUBIN-TOTAL', range: 'UP TO 1.2 MG/DL' },
                     { key: 'bilirubin_direct', name: 'S. BILIRUBIN-DIRECT', range: 'UP TO 0.4 MG/DL' },
                     { key: 'bilirubin_indirect', name: 'S. BILIRUBIN-INDIRECT', range: '0.1-1.0 MG/DL' },
                     { key: 'sgpt_alt', name: 'S.G.P.T.( ALT)', range: 'UP TO 40 U/L ( M - 13 TO 40 , F - 10 TO 28)' },
                     { key: 'sgot', name: 'S.G.O.T.', range: 'M - 0-37, F - 0 -31' },
                     { key: 'protein', name: 'PROTEIN', range: 'GM/DL 5.7 TO 8.2' },
                     { key: 'albumin', name: 'ALBUMIN', range: 'GM/DL  3.2 TO 4.8' },
                     { key: 'globulin', name: 'GLOBULIN', range: 'GM/DL 2,5 TO 3.4' },
                     { key: 'ag_ratio', name: 'ABUMIN/ GLOBULIN RATIO', range: '0.9 TO 2.0' }
                 ]
             },
             lipid: {
                 title: 'LIPID PROFILE',
                 tests: [
                     { key: 'homocystin', name: 'HOMOCYSTIN', range: '1.0-15.39 UMOL/L ( &gt;30 RISK )' },
                     { key: 'cholesterol', name: 'S.CHOLESTEROL', range: '125-200 MG/DL' },
                     { key: 'triglyceride', name: 'S.TRIGLYCERIDE', range: '&lt;150' },
                     { key: 'hdl', name: 'S.HDL', range: '35-70 MG/DL' },
                     { key: 'ldl', name: 'S.LDL', range: '&lt;100 MG%' },
                     { key: 'vldl', name: 'S.VLDL', range: '15-35 MG/DL' },
                     { key: 'ldl_hdl_ratio', name: 'LDL/HDL RATIO', range: '&lt;3' },
                     { key: 'chol_hdl_ratio', name: 'TOTAL CHOLESTEROL/HDL', range: '&lt;3.5' }
                 ]
             },
             inflammation: {
                 title: 'INFLAMMATION',
                 tests: [ { key: 'crp', name: 'CRP', range: 'UP TO 6 MG/DL ( &lt;1, 1 TO 3 AND &gt;3)' } ]
             },
             vitamind3: {
                 title: 'VITAMIN D3',
                 tests: [ { key: 'vit_d3', name: '25 OH CHOLECALCIFEROL (D2+D3) (CMIA)', range: '20-32 NG/ML' } ]
             },
             vitaminb12: {
                 title: 'VITAMIN B12',
                 tests: [ { key: 'vit_b12', name: 'B-12 LEVEL', range: '211-911 PG/ML' } ]
             },
             testosterone: {
                 title: 'TESTOSTERONE',
                 tests: [ { key: 'testosterone', name: 'TESTOSTERONE', range: 'M - 247 TO 827, F - 14 TO 76' } ]
             },
             thyroid: {
                 title: 'THYROID FUNCTION TEST',
                 tests: [
                     { key: 't3', name: 'T3', range: 'NG/DL 60 TO 200' },
                     { key: 't4', name: 'T4', range: 'MUG/DL 4.5 TO 12' },
                     { key: 'tsh', name: 'TSH', range: 'MIU/ML  0.3 TO 5.5' }
                 ]
             }
         };
         // Note: The HTML entities like &lt; and &gt; in the 'range' properties above are intentional.
         // They are used so that characters like '<' or '>' are displayed correctly as text in the HTML,
         // rather than being interpreted as HTML tags.
 
         function showMessage(element, message, type) {
             element.textContent = message;
             element.className = `message-area ${type}`;
         }
 
         async function fetchAssignedClients(queryParams = '') {
             showMessage(listClientsMessageDiv, 'Loading clients...', 'info');
             console.log('fetchAssignedClients called with params:', queryParams); // Log 1
             let url = '/api/nutritionist/my-clients';
             if (queryParams) url = `/api/nutritionist/my-clients/search?${queryParams}`;
             console.log('Fetching URL:', url); // Log 2
             try {
                 const response = await fetch(url, {
                      headers: { 'Authorization': `Bearer ${staffToken}` }
                  });
                 console.log('Fetch response status:', response.status); // Log 3
                 if (!response.ok) {
                     const errorData = await response.json().catch(() => ({ error: 'Failed to parse error from server' })); // Graceful error parsing
                     throw new Error(errorData.error || `Failed to fetch clients (HTTP ${response.status})`);
                 }
                 const clients = await response.json();
                 populateClientsTable(clients);
                 if (clients.length > 0) {
                     showMessage(listClientsMessageDiv, queryParams ? `Found ${clients.length} client(s).` : '', 'info');
                 } else {
                     showMessage(listClientsMessageDiv, queryParams ? 'No clients found matching your search.' : 'No clients assigned to you.', 'info');
                 }
             } catch (error) {
                 console.error('Error in fetchAssignedClients:', error); // Log 4
                 showMessage(listClientsMessageDiv, `Error: ${error.message}`, 'error');
             }
         }
 
         function populateClientsTable(clients) {
             clientsTableBody.innerHTML = '';
             if (!clients || clients.length === 0) {
                 clientsTableBody.innerHTML = '<tr><td colspan="5">No clients assigned.</td></tr>';
                 return;
             }
             clients.forEach(client => {
                 const row = clientsTableBody.insertRow();
                 row.innerHTML = `
                     <td>${client.client_id}</td>
                     <td>${client.first_name} ${client.last_name}</td>
                     <td>${client.email}</td>
                     <td>${client.mobile_number || 'N/A'}</td>
                     <td>
                         <div class="client-action-buttons-container">
                             <button class="action-btn view-biodata-btn" data-id="${client.client_id}">Biodata</button>
                             <button class="action-btn view-medical-history-btn" data-id="${client.client_id}">Med History</button>
                             <button class="action-btn view-blood-tests-btn" data-id="${client.client_id}">Blood Tests</button>
                             <button class="action-btn view-food-plan-btn" data-id="${client.client_id}">Manage Food Plan</button>
                         </div>
                     </td>`;
             });
         }
 
         clientsTableBody.addEventListener('click', async function(event) {
             const target = event.target.closest('.action-btn');
             if (!target) return;
             const clientId = target.dataset.id;
 
             if (target.classList.contains('view-biodata-btn')) {
                 openViewClientBiodataModal(clientId);
             } else if (target.classList.contains('view-medical-history-btn')) {
                 openViewClientMedicalHistoryModal(clientId);
             } else if (target.classList.contains('view-blood-tests-btn')) {
                 openViewClientBloodTestsModal(clientId);
             } else if (target.classList.contains('view-food-plan-btn')) {
                 openClientFoodPlanModal(clientId);
             }
         });
 
         // --- Modal Opening Functions (adapted from admin.html) ---
         async function openViewClientBiodataModal(clientId) {
             viewClientBiodataModalTitle.textContent = `Personal Details for Client ID: ${clientId}`;
             showMessage(viewClientBiodataMessageDiv, 'Loading...', 'info');
             viewClientBiodataModal.style.display = 'block';
             viewClientBiodataContentDiv.innerHTML = '';
             try {
                 const response = await fetch(`/api/staff/clients/${clientId}/personal-details`, { headers: { 'Authorization': `Bearer ${staffToken}` } });
                 const data = await response.json();
                 if (!response.ok) throw new Error(data.error || 'Failed to fetch');
                 let contentHtml = '';
                 for (const key in data) {
                     if (data.hasOwnProperty(key)) {
                         let value = data[key];
                         const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                         if (key.includes('date') && value) value = new Date(value).toLocaleDateString();
                         else if (typeof value === 'boolean') value = value ? 'Yes' : 'No';
                         else if (value === null || value === undefined || value === '') value = 'N/A';
                         contentHtml += `<div class="data-pair"><span class="data-label">${label}:</span><span class="data-value">${value}</span></div>`;
                     }
                 }
                 viewClientBiodataContentDiv.innerHTML = contentHtml;
                 showMessage(viewClientBiodataMessageDiv, 'Loaded.', 'info');
             } catch (error) {
                 showMessage(viewClientBiodataMessageDiv, error.message, 'error');
             }
         }
 
         async function openViewClientMedicalHistoryModal(clientId) {
             viewClientMedicalHistoryModalTitle.textContent = `Medical History for Client ID: ${clientId}`;
             showMessage(viewClientMedicalHistoryMessageDiv, 'Loading...', 'info');
             viewClientMedicalHistoryModal.style.display = 'block';
             viewSelfMedicalHistoryDiv.innerHTML = '';
             viewFamilyMedicalHistoryDiv.innerHTML = '';
             viewClientMedicationsTableBody.innerHTML = '';
             try {
                 const response = await fetch(`/api/staff/clients/${clientId}/medical-history/latest`, { headers: { 'Authorization': `Bearer ${staffToken}` } });
                 const data = await response.json();
                 if (!response.ok) throw new Error(data.error || 'Failed to fetch');
                 if (data.message && data.message.includes("No medical history found")) {
                     showMessage(viewClientMedicalHistoryMessageDiv, data.message, 'info');
                 } else {
                     viewSelfMedicalHistoryDiv.innerHTML = data.self_medical_history ? data.self_medical_history.replace(/\n/g, '<br>') : 'N/A';
                     viewFamilyMedicalHistoryDiv.innerHTML = data.family_medical_history ? data.family_medical_history.replace(/\n/g, '<br>') : 'N/A';
                     if (data.medications && data.medications.length > 0) {
                         data.medications.forEach(med => {
                             const row = viewClientMedicationsTableBody.insertRow();
                             row.innerHTML = `<td>${med.diagnosis||'N/A'}</td><td>${med.medicine_name||'N/A'}</td><td>${med.power||'N/A'}</td><td>${med.timing||'N/A'}</td><td>${med.since_when||'N/A'}</td>`;
                         });
                     } else {
                         viewClientMedicationsTableBody.innerHTML = '<tr><td colspan="5">No medications listed.</td></tr>';
                     }
                     showMessage(viewClientMedicalHistoryMessageDiv, 'Loaded.', 'info');
                 }
             } catch (error) {
                 showMessage(viewClientMedicalHistoryMessageDiv, error.message, 'error');
             }
         }
 
         async function openViewClientBloodTestsModal(clientId) {
             viewClientBloodTestsModalTitle.textContent = `Blood Tests for Client ID: ${clientId}`;
             showMessage(viewClientBloodTestsMessageDiv, 'Loading...', 'info');
             viewClientBloodTestsModal.style.display = 'block';
             viewClientBloodTestReportDatesDiv.innerHTML = '';
             viewClientBloodTestsTableContainer.innerHTML = '';
             try {
                 const response = await fetch(`/api/staff/clients/${clientId}/blood-tests/latest`, { headers: { 'Authorization': `Bearer ${staffToken}` } });
                 const data = await response.json();
                 if (!response.ok) throw new Error(data.error || 'Failed to fetch');
                 if (data.message && data.message.includes("No blood test reports found")) {
                     showMessage(viewClientBloodTestsMessageDiv, data.message, 'info'); return;
                 }
                 let reportDatesHtml = 'Report Dates: '; let hasDates = false;
                 for (let i = 1; i <= 5; i++) {
                     if (data[`report_date_${i}`]) { reportDatesHtml += `D${i}: ${new Date(data[`report_date_${i}`]).toLocaleDateString()} | `; hasDates = true; }
                 }
                 viewClientBloodTestReportDatesDiv.innerHTML = hasDates ? reportDatesHtml.slice(0, -3) : 'No report dates.';
                 const tableHeader = `<div class="test-header-row"><div>Test Name</div><div>Normal Range</div>${[1,2,3,4,5].map(i => `<div>Value D${i}</div>`).join('')}</div>`;
                 viewClientBloodTestsTableContainer.innerHTML = tableHeader;
                 for (const sectionKey in bloodTestDefinitions) {
                     const section = bloodTestDefinitions[sectionKey];
                     const sectionHeaderRow = document.createElement('div');
                     sectionHeaderRow.className = 'test-data-row';
                     sectionHeaderRow.innerHTML = `<div style="grid-column: 1 / -1; background-color: #e9ecef; font-weight: bold; padding: 8px;">${section.title}</div>`;
                     viewClientBloodTestsTableContainer.appendChild(sectionHeaderRow);
                     section.tests.forEach(testDef => {
                         const clientResult = data.results ? data.results.find(r => r.test_code === testDef.key) : null;
                         const row = document.createElement('div');
                         row.className = 'test-data-row';
                         row.innerHTML = `<div class="test-name">${testDef.name}</div><div class="normal-range">${testDef.range || 'N/A'}</div>
                             <div>${clientResult?.value_d1 || 'N/A'}</div><div>${clientResult?.value_d2 || 'N/A'}</div>
                             <div>${clientResult?.value_d3 || 'N/A'}</div><div>${clientResult?.value_d4 || 'N/A'}</div>
                             <div>${clientResult?.value_d5 || 'N/A'}</div>`;
                         viewClientBloodTestsTableContainer.appendChild(row);
                     });
                 }
                 showMessage(viewClientBloodTestsMessageDiv, 'Loaded.', 'info');
             } catch (error) {
                 showMessage(viewClientBloodTestsMessageDiv, error.message, 'error');
             }
         }
 
         // --- Client Food Plan Modal (Nutritionist - Editable, No CKEditor for hourly) ---
         function generateTimeSlots() {
             const slots = [];
             for (let i = 0; i < 24; i++) {
                 const hour = (6 + i) % 24;
                 slots.push({
                     formValue: `${String(hour).padStart(2, '0')}:00`,
                     displayValue: `${String(hour % 12 || 12).padStart(2, '0')}:00 ${hour >= 12 ? 'PM' : 'AM'}`
                 });
             }
             return slots;
         }
 
         async function openClientFoodPlanModal(clientId) {
             document.getElementById('editing_client_id_for_food_plan').value = clientId;
             clientFoodPlanModalTitle.textContent = `Manage Food Plan for Client ID: ${clientId}`;
             showMessage(clientFoodPlanMessageDiv, 'Loading food plan...', 'info');
             clientFoodPlanModal.style.display = 'block';
 
             clientFoodPlanHourlyTableBody.innerHTML = ''; // Clear previous rows
 
             const timeSlots = generateTimeSlots();
             timeSlots.forEach(slot => {
                 const row = clientFoodPlanHourlyTableBody.insertRow();
                 const timeKey = slot.formValue.replace(':', '');
                 row.innerHTML = `<td class="time-column">${slot.displayValue}</td>
                     <td><textarea id="fp_present_intake_${timeKey}" name="present_intake_${timeKey}"></textarea></td>
                     <td><textarea id="fp_proposed_structure_${timeKey}" name="proposed_structure_${timeKey}"></textarea></td>
                     <td><textarea id="fp_additional_points_${timeKey}" name="additional_points_${timeKey}"></textarea></td>`;
             });
             
             // Clear personal recommendations textarea
             clientFoodPlanPersonalRecommendationsTextarea.value = '';
 
             try { // Fetch general admin recommendations
                 const genRecResponse = await fetch('/api/general-food-recommendations', { headers: { 'Authorization': `Bearer ${staffToken}` } });
                 if (genRecResponse.ok) {
                     const genRecData = await genRecResponse.json();
                     clientFoodPlanGeneralAdminRecommendationsDisplay.innerHTML = genRecData.recommendations || 'N/A';
                 } else { clientFoodPlanGeneralAdminRecommendationsDisplay.innerHTML = 'Error loading general recs.'; }
             } catch (error) { clientFoodPlanGeneralAdminRecommendationsDisplay.innerHTML = 'Error loading general recs.'; }
 
             try { // Fetch client's latest food plan
                 const response = await fetch(`/api/staff/clients/${clientId}/food-plan/latest`, { headers: { 'Authorization': `Bearer ${staffToken}` } });
                 const planData = await response.json();
                 if (!response.ok) throw new Error(planData.error || 'Failed to load plan');
 
                 if (planData.message && planData.message.includes("No food plan found")) {
                     showMessage(clientFoodPlanMessageDiv, 'No existing food plan. Create a new one.', 'info');
                     clientFoodPlanPersonalRecommendationsTextarea.value = '';
                     clientFoodPlanHourlyTableBody.querySelectorAll('textarea').forEach(ta => ta.value = '');
                 } else {
                     clientFoodPlanPersonalRecommendationsTextarea.value = planData.additional_personal_recommendations || '';
                     
                     planData.hourly_details.forEach(detail => {
                         const timeKey = detail.time_slot.replace(':', '');
                         const presentIntakeTextarea = document.getElementById(`fp_present_intake_${timeKey}`);
                         if (presentIntakeTextarea) presentIntakeTextarea.value = detail.present_intake || '';
                         
                         const proposedStructureTextarea = document.getElementById(`fp_proposed_structure_${timeKey}`);
                         if (proposedStructureTextarea) proposedStructureTextarea.value = detail.proposed_structure || '';
 
                         const additionalPointsTextarea = document.getElementById(`fp_additional_points_${timeKey}`);
                         if (additionalPointsTextarea) additionalPointsTextarea.value = detail.additional_points || '';
                     });
                     showMessage(clientFoodPlanMessageDiv, 'Client food plan loaded.', 'info');
                 }
             } catch (error) {
                 showMessage(clientFoodPlanMessageDiv, error.message, 'error');
                 clientFoodPlanPersonalRecommendationsTextarea.value = '';
                 clientFoodPlanHourlyTableBody.querySelectorAll('textarea').forEach(ta => ta.value = '');
             }
         }
 
         clientFoodPlanEditForm.addEventListener('submit', async function(event) {
             event.preventDefault();
             const clientId = document.getElementById('editing_client_id_for_food_plan').value;
             const dataToSend = { hourly_plan: {} };
             
             dataToSend.additional_personal_recommendations = clientFoodPlanPersonalRecommendationsTextarea.value;
 
             const timeSlots = generateTimeSlots();
             timeSlots.forEach(slot => {
                 const timeKeyForBackend = slot.formValue;
                 const timeKeyForEditorId = slot.formValue.replace(':', '');
                 
                 dataToSend.hourly_plan[timeKeyForBackend] = {
                     present_intake: document.getElementById(`fp_present_intake_${timeKeyForEditorId}`)?.value || null,
                     proposed_structure: document.getElementById(`fp_proposed_structure_${timeKeyForEditorId}`)?.value || null,
                     additional_points: document.getElementById(`fp_additional_points_${timeKeyForEditorId}`)?.value || null
                 };
             });
             showMessage(clientFoodPlanMessageDiv, 'Saving...', 'info');
             try {
                 const response = await fetch(`/api/nutritionist/clients/${clientId}/food-plan`, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${staffToken}` },
                     body: JSON.stringify(dataToSend)
                 });
                 const result = await response.json();
                 if (!response.ok) throw new Error(result.error || 'Failed to save');
                 showMessage(clientFoodPlanMessageDiv, result.message, 'success');
                 setTimeout(() => {
                     clientFoodPlanModal.style.display = 'none';
                     document.getElementById('assigned-clients').scrollIntoView({ behavior: 'smooth' });
                 }, 2000);
             } catch (error) {
                 showMessage(clientFoodPlanMessageDiv, error.message, 'error');
             }
         });
 
         searchMyClientsForm.addEventListener('submit', async function(event) {
             event.preventDefault();
             console.log('Nutritionist search form submitted!'); // Log 5
             const formData = new FormData(this);
             const searchParams = new URLSearchParams();
             for (const [key, value] of formData.entries()) {
                 if (value) { // only add params if they have a value
                     searchParams.append(key, value);
                 }
             }
             fetchAssignedClients(searchParams.toString());
         });
 
         clearSearchMyClientsBtn.addEventListener('click', () => {
             searchMyClientsForm.reset();
             console.log('Nutritionist search cleared, fetching all assigned clients.'); // Log 6
             fetchAssignedClients();
         });
 
 
         // --- Modal Close Handlers ---
         function setupModalCloseButton(modalElement, closeButtonId) {
             const closeBtn = document.getElementById(closeButtonId);
             if (closeBtn) closeBtn.onclick = () => { modalElement.style.display = "none"; };
         }
         setupModalCloseButton(viewClientBiodataModal, 'closeViewClientBiodataModalBtn');
         setupModalCloseButton(viewClientMedicalHistoryModal, 'closeViewClientMedicalHistoryModalBtn');
         setupModalCloseButton(viewClientBloodTestsModal, 'closeViewClientBloodTestsModalBtn');
         setupModalCloseButton(clientFoodPlanModal, 'closeClientFoodPlanModalBtn');
 
         window.onclick = function(event) {
             if (event.target == viewClientBiodataModal) viewClientBiodataModal.style.display = "none";
             if (event.target == viewClientMedicalHistoryModal) viewClientMedicalHistoryModal.style.display = "none";
             if (event.target == viewClientBloodTestsModal) viewClientBloodTestsModal.style.display = "none";
             if (event.target == clientFoodPlanModal) clientFoodPlanModal.style.display = "none";
         };
         
         document.querySelectorAll('.navbar-links a[href^="#"]').forEach(anchor => {
             anchor.addEventListener('click', function (e) {
                 e.preventDefault();
                 const targetElement = document.querySelector(this.getAttribute('href'));
                 if (targetElement) targetElement.scrollIntoView({ behavior: 'smooth' });
             });
         });
 
         logoutButton.addEventListener('click', () => {
             localStorage.removeItem('staffToken');
             window.location.href = '/staff-login.html';
         });
 
         document.addEventListener('DOMContentLoaded', () => {
             fetchAssignedClients();
         });
     </script>
 </body>
 </html>
 