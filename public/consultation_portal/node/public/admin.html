  <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Add CKEditor 5 CDN -->
    <script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/classic/ckeditor.js"></script>
    <link rel="stylesheet" href="admin_style.css">
</head>
<body>
    <header class="navbar">
        <div class="navbar-brand">Admin Dashboard</div>
        <nav class="navbar-links">
            <ul>
                <li><a href="#manage-nutritionists">Nutritionists</a></li>
                <li><a href="#manage-executives">Executives</a></li>
                <li><a href="#manage-clients">Clients</a></li>
                <li><a href="#generalFoodRecommendationsSection">General Recs</a></li>
                <li><button id="logoutButton" class="nav-logout-btn">Logout</button></li>
            </ul>
        </nav>
    </header>

    <div class="stats-cards-container">
        <!-- Statistics cards will go here later -->
        <div class="stat-card">Total Nutritionists: <span id="totalNutritionists">0</span></div>
        <div class="stat-card">Total Executives: <span id="totalExecutives">0</span></div>
        <div class="stat-card">Total Clients: <span id="totalClients">0</span></div>
    </div>

    <main class="admin-container">
        <section id="manage-nutritionists" class="management-section">
            <h2>Manage Nutritionists</h2>
            <div class="add-form">
                <h3>Add New Nutritionist</h3>
                <form id="addNutritionistForm">
                    <div class="form-group">
                        <label for="nutri_first_name">First Name:</label>
                        <input type="text" id="nutri_first_name" required>
                    </div>
                    <div class="form-group">
                        <label for="nutri_last_name">Last Name:</label>
                        <input type="text" id="nutri_last_name" required>
                    </div>
                    <div class="form-group">
                        <label for="nutri_email">Email:</label>
                        <input type="email" id="nutri_email" required>
                    </div>
                    <div class="form-group">
                        <label for="nutri_password">Initial Password:</label>
                        <input type="password" id="nutri_password" required minlength="6">
                    </div>
                    <button type="submit" class="submit-btn">Add Nutritionist</button>
                </form>
                <div id="addNutriMessage" class="message-area"></div>
            </div>

            <h3>Existing Nutritionists</h3>
            <table id="nutritionistsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Email</th>
                        <th>Active</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="nutritionistsTableBody">
                    <!-- Nutritionist rows will be populated by JavaScript -->
                </tbody>
            </table>
            <div id="listNutriMessage" class="message-area"></div>
        </section>

        <section id="manage-executives" class="management-section">
            <h2>Manage Executives</h2>
            <div class="add-form">
                <h3>Add New Executive</h3>
                <form id="addExecutiveForm">
                    <div class="form-group">
                        <label for="exec_first_name">First Name:</label>
                        <input type="text" id="exec_first_name" required>
                    </div>
                    <div class="form-group">
                        <label for="exec_last_name">Last Name:</label>
                        <input type="text" id="exec_last_name" required>
                    </div>
                    <div class="form-group">
                        <label for="exec_email">Email:</label>
                        <input type="email" id="exec_email" required>
                    </div>
                    <div class="form-group">
                        <label for="exec_password">Initial Password:</label>
                        <input type="password" id="exec_password" required minlength="6">
                    </div>
                    <button type="submit" class="submit-btn">Add Executive</button>
                </form>
                <div id="addExecMessage" class="message-area"></div>
            </div>

            <h3>Existing Executives</h3>
            <table id="executivesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Email</th>
                        <th>Active</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="executivesTableBody">
                    <!-- Executive rows will be populated by JavaScript -->
                </tbody>
            </table>
            <div id="listExecMessage" class="message-area"></div>
        </section>

        <section id="manage-clients" class="management-section">
            <h2>Manage Clients</h2>
            <div class="search-container" style="margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px; background-color: #fdfdfd;">
                <h3>Search Clients</h3>
                <form id="searchClientsForm" style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <div class="form-group" style="flex-grow: 1; min-width: 150px;">
                        <label for="search_client_id" style="flex-basis: auto; margin-bottom: 5px;">Client ID:</label>
                        <input type="text" id="search_client_id" name="client_id" style="width: 100%;">
                    </div>
                    <div class="form-group" style="flex-grow: 1; min-width: 150px;">
                        <label for="search_first_name" style="flex-basis: auto; margin-bottom: 5px;">First Name:</label>
                        <input type="text" id="search_first_name" name="first_name" style="width: 100%;">
                    </div>
                    <div class="form-group" style="flex-grow: 1; min-width: 150px;">
                        <label for="search_last_name" style="flex-basis: auto; margin-bottom: 5px;">Last Name:</label>
                        <input type="text" id="search_last_name" name="last_name" style="width: 100%;">
                    </div>
                    <div class="form-group" style="flex-grow: 1; min-width: 150px;">
                        <label for="search_email" style="flex-basis: auto; margin-bottom: 5px;">Email:</label>
                        <input type="email" id="search_email" name="email" style="width: 100%;">
                    </div>
                    <button type="submit" class="submit-btn" style="align-self: flex-end;">Search</button>
                    <button type="button" id="clearSearchClientsBtn" class="submit-btn" style="align-self: flex-end; background-color: #6c757d;">Clear</button>
                </form>
            </div>
            <table id="allClientsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Mobile</th>
                        <th>Registered</th>
                        <th>Email Verified</th>
                        <th>Account Active</th>
                        <th>Assigned Nutritionist</th>
                        <th>Enrolled By Executive</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="allClientsTableBody">
                    <!-- Client rows will be populated by JavaScript -->
                </tbody>
            </table>
            <div id="listAllClientsMessage" class="message-area"></div>
        </section>

        <section id="generalFoodRecommendationsSection" class="management-section">
            <h2>Manage General Food Recommendations</h2>
            <p>These recommendations will be displayed to all clients on their food plan page.</p>
            <form id="generalRecommendationsForm">
                <div class="form-group" style="flex-direction: column; align-items: flex-start;">
                    <label for="adminGeneralRecommendationsText" style="flex-basis: auto; margin-bottom: 8px;">Recommendations Text:</label>
                    <textarea id="adminGeneralRecommendationsText" name="recommendations_text" rows="10"></textarea>
                </div>
                <button type="submit" class="submit-btn">Save General Recommendations</button>
            </form>
            <div id="adminGeneralRecsMessage" class="message-area"></div>
        </section>
    </main>

    <!-- Modal for Viewing Client Medical History (Admin) -->
    <div id="viewClientMedicalHistoryModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-btn" id="closeViewClientMedicalHistoryModalBtn">&times;</span>
            <h3 id="viewClientMedicalHistoryModalTitle">Client Medical History</h3>
            <h4>Self Medical History</h4>
            <div id="viewSelfMedicalHistory" class="read-only-display"></div>
            <h4>Family Medical History</h4>
            <div id="viewFamilyMedicalHistory" class="read-only-display"></div>
            <h4>Medications</h4>
            <table class="medications-table-readonly">
                <thead>
                    <tr>
                        <th>Diagnosis</th>
                        <th>Medicine Name</th>
                        <th>Power</th>
                        <th>Timing</th>
                        <th>Since When</th>
                    </tr>
                </thead>
                <tbody id="viewClientMedicationsTableBody"></tbody>
            </table>
            <div id="viewClientMedicalHistoryMessage" class="message-area"></div>
        </div>
    </div>

    <!-- Modal for Viewing Client Biodata (Personal Details - Admin) -->
    <div id="viewClientBiodataModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-btn" id="closeViewClientBiodataModalBtn">&times;</span>
            <h3 id="viewClientBiodataModalTitle">Client Personal Details</h3>
            <div id="viewClientBiodataContent" class="read-only-grid-display"></div>
            <div id="viewClientBiodataMessage" class="message-area"></div>
        </div>
    </div>
    
    <!-- Modal for Admin to View Client Blood Tests -->
    <div id="viewClientBloodTestsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 950px;">
            <span class="close-btn" id="closeViewClientBloodTestsModalBtn">&times;</span>
            <h3 id="viewClientBloodTestsModalTitle">Client Blood Test Results</h3>
            <div id="viewClientBloodTestReportDates" style="margin-bottom: 15px; font-weight: bold;"></div>
            <div id="viewClientBloodTestsTableContainer" class="test-table">
                <!-- Blood test table will be dynamically generated here -->
            </div>
            <div id="viewClientBloodTestsMessage" class="message-area"></div>
        </div>
    </div>


    <!-- Modal for Client Food Plan -->
    <div id="clientFoodPlanModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close-btn" id="closeClientFoodPlanModalBtn">&times;</span>
            <h3 id="clientFoodPlanModalTitle">Client Food Plan</h3>
            <form id="clientFoodPlanEditForm">
                <input type="hidden" id="editing_client_id_for_food_plan">
                <h4>Hourly Food Plan</h4>
                <table class="hourly-plan-table">
                    <thead>
                        <tr>
                            <th class="time-column">Time</th>
                            <th>Present Intake</th>
                            <th>Proposed Structure</th>
                            <th>Additional Points</th>
                        </tr>
                    </thead>
                    <tbody id="clientFoodPlanHourlyTableBody"></tbody>
                </table>
                <div class="form-group" style="margin-top: 20px;">
                    <label for="clientFoodPlanPersonalRecommendations">Additional Personal Recommendations (for this client):</label>
                    <textarea id="clientFoodPlanPersonalRecommendations" name="additional_personal_recommendations" rows="5"></textarea>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label>General Admin Recommendations (for context - read-only):</label>
                    <div id="clientFoodPlanGeneralAdminRecommendationsDisplay" class="read-only-display">Loading...</div>
                </div>
                <button type="submit" class="submit-btn">Save Client Food Plan</button>
            </form>
            <div id="clientFoodPlanMessage" class="message-area"></div>
        </div>
    </div>

    <!-- Modal for assigning nutritionist/executive -->
    <div id="assignStaffModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" id="closeAssignStaffModalBtn">&times;</span>
            <h3 id="assignStaffModalTitle">Assign Staff</h3>
            <select id="staffDropdown"></select>
            <button id="confirmStaffAssignmentBtn" class="submit-btn">Confirm Assignment</button>
            <div id="assignStaffMessage" class="message-area"></div>
        </div>
    </div>

    <!-- Modal for Editing Client -->
    <div id="editClientModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" id="closeEditClientModalBtn">&times;</span>
            <h3>Edit Client Details</h3>
            <form id="editClientForm">
                <input type="hidden" id="edit_client_id">
                <div class="form-group">
                    <label for="edit_client_first_name">First Name:</label>
                    <input type="text" id="edit_client_first_name" required>
                </div>
                <div class="form-group">
                    <label for="edit_client_last_name">Last Name:</label>
                    <input type="text" id="edit_client_last_name" required>
                </div>
                <div class="form-group">
                    <label for="edit_client_email">Email:</label>
                    <input type="email" id="edit_client_email" required>
                </div>
                <div class="form-group">
                    <label for="edit_client_mobile_number">Mobile Number:</label>
                    <input type="tel" id="edit_client_mobile_number" required>
                </div>
                <button type="submit" class="submit-btn">Save Client Changes</button>
            </form>
            <div id="editClientMessage" class="message-area"></div>
        </div>
    </div>

    <script>
        const addNutriForm = document.getElementById('addNutritionistForm');
        const addNutriMessageDiv = document.getElementById('addNutriMessage');
        const nutritionistsTableBody = document.querySelector('#nutritionistsTable tbody');
        const listNutriMessageDiv = document.getElementById('listNutriMessage');
        const nutriFormTitle = document.querySelector('#manage-nutritionists .add-form h3');
        let currentEditUserId = null;

        const addExecForm = document.getElementById('addExecutiveForm');
        const addExecMessageDiv = document.getElementById('addExecMessage');
        const executivesTableBody = document.querySelector('#executivesTable tbody');
        const listExecMessageDiv = document.getElementById('listExecMessage');
        const execFormTitle = document.querySelector('#manage-executives .add-form h3');
        let currentEditExecId = null;

        const allClientsTableBody = document.querySelector('#allClientsTable tbody');
        const listAllClientsMessageDiv = document.getElementById('listAllClientsMessage');
        const searchClientsForm = document.getElementById('searchClientsForm');
        const clearSearchClientsBtn = document.getElementById('clearSearchClientsBtn');

        const logoutButton = document.getElementById('logoutButton');

        const assignStaffModal = document.getElementById('assignStaffModal');
        const assignStaffModalTitle = document.getElementById('assignStaffModalTitle');
        const staffDropdown = document.getElementById('staffDropdown');
        const confirmStaffAssignmentBtn = document.getElementById('confirmStaffAssignmentBtn');
        const assignStaffMessageDiv = document.getElementById('assignStaffMessage');
        const closeAssignStaffModalBtn = document.getElementById('closeAssignStaffModalBtn');

        const editClientModal = document.getElementById('editClientModal');
        const editClientForm = document.getElementById('editClientForm');
        const editClientMessageDiv = document.getElementById('editClientMessage');
        const closeEditClientModalBtn = document.getElementById('closeEditClientModalBtn');
        let currentEditingClientId = null;

        const generalRecommendationsForm = document.getElementById('generalRecommendationsForm');
        const adminGeneralRecommendationsText = document.getElementById('adminGeneralRecommendationsText');
        const adminGeneralRecsMessageDiv = document.getElementById('adminGeneralRecsMessage');
        let generalRecommendationsEditor;

        const clientFoodPlanModal = document.getElementById('clientFoodPlanModal');
        const clientFoodPlanModalTitle = document.getElementById('clientFoodPlanModalTitle');
        const clientFoodPlanEditForm = document.getElementById('clientFoodPlanEditForm');
        const clientFoodPlanHourlyTableBody = document.getElementById('clientFoodPlanHourlyTableBody');
        const clientFoodPlanPersonalRecommendationsTextarea = document.getElementById('clientFoodPlanPersonalRecommendations');
        const clientFoodPlanGeneralAdminRecommendationsDisplay = document.getElementById('clientFoodPlanGeneralAdminRecommendationsDisplay');
        const clientFoodPlanMessageDiv = document.getElementById('clientFoodPlanMessage');
        const closeClientFoodPlanModalBtn = document.getElementById('closeClientFoodPlanModalBtn');
        let clientFoodPlanEditors = {}; // To store CKEditor instances for food plan

        const viewClientMedicalHistoryModal = document.getElementById('viewClientMedicalHistoryModal');
        const viewClientMedicalHistoryModalTitle = document.getElementById('viewClientMedicalHistoryModalTitle');
        const viewSelfMedicalHistoryDiv = document.getElementById('viewSelfMedicalHistory');
        const viewFamilyMedicalHistoryDiv = document.getElementById('viewFamilyMedicalHistory');
        const viewClientMedicationsTableBody = document.getElementById('viewClientMedicationsTableBody');
        const viewClientMedicalHistoryMessageDiv = document.getElementById('viewClientMedicalHistoryMessage');
        const closeViewClientMedicalHistoryModalBtn = document.getElementById('closeViewClientMedicalHistoryModalBtn');
        
        const viewClientBiodataModal = document.getElementById('viewClientBiodataModal');
        const viewClientBiodataModalTitle = document.getElementById('viewClientBiodataModalTitle');
        const viewClientBiodataContentDiv = document.getElementById('viewClientBiodataContent');
        const viewClientBiodataMessageDiv = document.getElementById('viewClientBiodataMessage');
        const closeViewClientBiodataModalBtn = document.getElementById('closeViewClientBiodataModalBtn');

        const viewClientBloodTestsModal = document.getElementById('viewClientBloodTestsModal');
        const viewClientBloodTestsModalTitle = document.getElementById('viewClientBloodTestsModalTitle');
        const viewClientBloodTestReportDatesDiv = document.getElementById('viewClientBloodTestReportDates');
        const viewClientBloodTestsTableContainer = document.getElementById('viewClientBloodTestsTableContainer');
        const viewClientBloodTestsMessageDiv = document.getElementById('viewClientBloodTestsMessage');
        const closeViewClientBloodTestsModalBtn = document.getElementById('closeViewClientBloodTestsModalBtn');


        const adminToken = localStorage.getItem('adminToken');
        if (!adminToken) {
            window.location.href = '/admin-login.html';
        }

        function showMessage(element, message, type) {
            element.textContent = message;
            element.className = `message-area ${type}`;
        }

        // --- Nutritionist Management ---
        async function fetchNutritionists() {
            try {
                const response = await fetch('/api/admin/nutritionists', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                if (!response.ok) throw new Error((await response.json()).error || 'Failed to fetch');
                const nutritionists = await response.json();
                nutritionistsTableBody.innerHTML = '';
                if (nutritionists.length === 0) {
                    nutritionistsTableBody.innerHTML = '<tr><td colspan="6">No nutritionists found.</td></tr>';
                } else {
                    nutritionists.forEach(n => {
                        const row = nutritionistsTableBody.insertRow();
                        row.innerHTML = `
                            <td>${n.user_id}</td><td>${n.first_name}</td><td>${n.last_name}</td><td>${n.email}</td>
                            <td>${n.is_active ? 'Yes' : 'No'}</td>
                            <td>
                                <button class="action-btn edit-btn nutri-edit-btn" data-id="${n.user_id}" data-first_name="${n.first_name}" data-last_name="${n.last_name}" data-email="${n.email}">Edit</button>
                                <button class="action-btn status-toggle-btn nutri-status-toggle-btn ${n.is_active ? 'deactivate-btn' : 'activate-btn'}" data-id="${n.user_id}" data-is_active="${n.is_active}">${n.is_active ? 'Deactivate' : 'Activate'}</button>
                            </td>`;
                    });
                }
                document.getElementById('totalNutritionists').textContent = nutritionists.length;
            } catch (error) {
                showMessage(listNutriMessageDiv, error.message, 'error');
            }
        }

        function resetNutriFormToAddMode() {
            nutriFormTitle.textContent = 'Add New Nutritionist';
            addNutriForm.querySelector('.submit-btn').textContent = 'Add Nutritionist';
            document.getElementById('nutri_password').parentElement.style.display = '';
            document.getElementById('nutri_password').required = true;
            addNutriForm.reset();
            currentEditUserId = null;
            showMessage(addNutriMessageDiv, '', 'info');
        }

        addNutriForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const data = {
                first_name: document.getElementById('nutri_first_name').value,
                last_name: document.getElementById('nutri_last_name').value,
                email: document.getElementById('nutri_email').value,
            };
            if (!currentEditUserId) data.password = document.getElementById('nutri_password').value;

            const url = currentEditUserId ? `/api/admin/nutritionists/${currentEditUserId}` : '/api/admin/nutritionists';
            const method = currentEditUserId ? 'PUT' : 'POST';
            showMessage(addNutriMessageDiv, 'Processing...', 'info');
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Operation failed');
                showMessage(addNutriMessageDiv, result.message, 'success');
                resetNutriFormToAddMode();
                fetchNutritionists();
            } catch (error) {
                showMessage(addNutriMessageDiv, error.message, 'error');
            }
        });

        nutritionistsTableBody.addEventListener('click', async function(event) {
            const target = event.target;
            const userId = target.dataset.id;
            if (target.classList.contains('nutri-edit-btn')) {
                nutriFormTitle.textContent = 'Edit Nutritionist';
                addNutriForm.querySelector('.submit-btn').textContent = 'Update Nutritionist';
                document.getElementById('nutri_first_name').value = target.dataset.first_name;
                document.getElementById('nutri_last_name').value = target.dataset.last_name;
                document.getElementById('nutri_email').value = target.dataset.email;
                document.getElementById('nutri_password').parentElement.style.display = 'none';
                document.getElementById('nutri_password').required = false;
                currentEditUserId = userId;
                showMessage(addNutriMessageDiv, 'Editing. Password not changed here.', 'info');
                window.scrollTo(0, addNutriForm.offsetTop);
            } else if (target.classList.contains('nutri-status-toggle-btn')) {
                const newStatus = !(target.dataset.is_active === 'true');
                if (confirm(`Sure you want to ${newStatus ? 'activate' : 'deactivate'}?`)) {
                    try {
                        const response = await fetch(`/api/admin/nutritionists/${userId}/status`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` },
                            body: JSON.stringify({ is_active: newStatus })
                        });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.error);
                        showMessage(listNutriMessageDiv, result.message, 'success');
                        fetchNutritionists();
                    } catch (error) { showMessage(listNutriMessageDiv, error.message, 'error'); }
                }
            }
        });

        // --- Executive Management (similar to Nutritionist) ---
        async function fetchExecutives() {
            try {
                const response = await fetch('/api/admin/executives', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                if (!response.ok) throw new Error((await response.json()).error || 'Failed to fetch');
                const executives = await response.json();
                executivesTableBody.innerHTML = '';
                if (executives.length === 0) {
                    executivesTableBody.innerHTML = '<tr><td colspan="6">No executives found.</td></tr>';
                } else {
                    executives.forEach(e => {
                        const row = executivesTableBody.insertRow();
                        row.innerHTML = `
                            <td>${e.user_id}</td><td>${e.first_name}</td><td>${e.last_name}</td><td>${e.email}</td>
                            <td>${e.is_active ? 'Yes' : 'No'}</td>
                            <td>
                                <button class="action-btn edit-btn exec-edit-btn" data-id="${e.user_id}" data-first_name="${e.first_name}" data-last_name="${e.last_name}" data-email="${e.email}">Edit</button>
                                <button class="action-btn status-toggle-btn exec-status-toggle-btn ${e.is_active ? 'deactivate-btn' : 'activate-btn'}" data-id="${e.user_id}" data-is_active="${e.is_active}">${e.is_active ? 'Deactivate' : 'Activate'}</button>
                            </td>`;
                    });
                }
                document.getElementById('totalExecutives').textContent = executives.length;
            } catch (error) {
                showMessage(listExecMessageDiv, error.message, 'error');
            }
        }

        function resetExecFormToAddMode() {
            execFormTitle.textContent = 'Add New Executive';
            addExecForm.querySelector('.submit-btn').textContent = 'Add Executive';
            document.getElementById('exec_password').parentElement.style.display = '';
            document.getElementById('exec_password').required = true;
            addExecForm.reset();
            currentEditExecId = null;
            showMessage(addExecMessageDiv, '', 'info');
        }

        addExecForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const data = {
                first_name: document.getElementById('exec_first_name').value,
                last_name: document.getElementById('exec_last_name').value,
                email: document.getElementById('exec_email').value,
            };
            if (!currentEditExecId) data.password = document.getElementById('exec_password').value;

            const url = currentEditExecId ? `/api/admin/executives/${currentEditExecId}` : '/api/admin/executives';
            const method = currentEditExecId ? 'PUT' : 'POST';
            showMessage(addExecMessageDiv, 'Processing...', 'info');
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Operation failed');
                showMessage(addExecMessageDiv, result.message, 'success');
                resetExecFormToAddMode();
                fetchExecutives();
            } catch (error) {
                showMessage(addExecMessageDiv, error.message, 'error');
            }
        });

        executivesTableBody.addEventListener('click', async function(event) {
            const target = event.target;
            const userId = target.dataset.id;
            if (target.classList.contains('exec-edit-btn')) {
                execFormTitle.textContent = 'Edit Executive';
                addExecForm.querySelector('.submit-btn').textContent = 'Update Executive';
                document.getElementById('exec_first_name').value = target.dataset.first_name;
                document.getElementById('exec_last_name').value = target.dataset.last_name;
                document.getElementById('exec_email').value = target.dataset.email;
                document.getElementById('exec_password').parentElement.style.display = 'none';
                document.getElementById('exec_password').required = false;
                currentEditExecId = userId;
                showMessage(addExecMessageDiv, 'Editing. Password not changed here.', 'info');
                document.getElementById('manage-executives').scrollIntoView({ behavior: 'smooth' });
            } else if (target.classList.contains('exec-status-toggle-btn')) {
                const newStatus = !(target.dataset.is_active === 'true');
                if (confirm(`Sure you want to ${newStatus ? 'activate' : 'deactivate'}?`)) {
                    try {
                        const response = await fetch(`/api/admin/executives/${userId}/status`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` },
                            body: JSON.stringify({ is_active: newStatus })
                        });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.error);
                        showMessage(listExecMessageDiv, result.message, 'success');
                        fetchExecutives();
                    } catch (error) { showMessage(listExecMessageDiv, error.message, 'error'); }
                }
            }
        });

        // --- Client Management ---
        function populateClientsTable(clients) {
            allClientsTableBody.innerHTML = '';
            if (!clients || clients.length === 0) {
                allClientsTableBody.innerHTML = '<tr><td colspan="10">No clients found.</td></tr>';
                if (document.getElementById('totalClients')) document.getElementById('totalClients').textContent = 0;
                return;
            }
            clients.forEach(client => {
                const row = allClientsTableBody.insertRow();
                row.innerHTML = `
                    <td>${client.client_id}</td>
                    <td>${client.first_name} ${client.last_name}</td>
                    <td>${client.email}</td>
                    <td>${client.mobile_number || 'N/A'}</td>
                    <td>${new Date(client.registration_date).toLocaleDateString()}</td>
                    <td>${client.is_email_verified ? 'Yes' : 'No'}</td>
                    <td>${client.is_account_active ? 'Yes' : 'No'}</td>
                    <td>${client.nutritionist_name || (client.nutritionist_id ? `ID: ${client.nutritionist_id}` : 'N/A')}</td>
                    <td>${client.executive_name || (client.enrolled_by_executive_id ? `ID: ${client.enrolled_by_executive_id}` : 'N/A')}</td>
                    <td>
                        <div class="client-action-buttons-container">
                            <button class="action-btn view-food-plan-btn" data-id="${client.client_id}">Food Plan</button>
                            <button class="action-btn view-biodata-btn" data-id="${client.client_id}">Biodata</button>
                            <button class="action-btn view-medical-history-btn" data-id="${client.client_id}">Med History</button>
                            <button class="action-btn view-blood-tests-btn" data-id="${client.client_id}">Blood Tests</button>
                            <button class="action-btn assign-nutri-btn" data-id="${client.client_id}">Assign Nutri</button>
                            <button class="action-btn link-exec-btn" data-id="${client.client_id}">Link Exec</button>
                            <button class="action-btn edit-client-btn" data-id="${client.client_id}">Edit Client</button>
                            <button class="action-btn toggle-active-btn ${client.is_account_active ? 'deactivate-btn' : 'activate-btn'}" data-id="${client.client_id}" data-current_active="${client.is_account_active}">
                                ${client.is_account_active ? 'Deactivate' : 'Activate'} Acct
                            </button>
                        </div>
                    </td>`;
            });
            if (document.getElementById('totalClients')) document.getElementById('totalClients').textContent = clients.length;
        }

        async function fetchAllClients() {
            showMessage(listAllClientsMessageDiv, 'Loading clients...', 'info');
            try {
                const response = await fetch('/api/admin/clients', { headers: { 'Authorization': `Bearer ${adminToken}` } });
                if (!response.ok) throw new Error((await response.json()).error || 'Failed to fetch');
                const clients = await response.json();
                populateClientsTable(clients);
                showMessage(listAllClientsMessageDiv, clients.length > 0 ? '' : 'No clients found.', 'info');
            } catch (error) {
                showMessage(listAllClientsMessageDiv, error.message, 'error');
            }
        }

        searchClientsForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const queryParams = new URLSearchParams(new FormData(this)).toString();
            if (!queryParams) {
                showMessage(listAllClientsMessageDiv, 'Enter search criteria.', 'info');
                return;
            }
            showMessage(listAllClientsMessageDiv, 'Searching...', 'info');
            try {
                const response = await fetch(`/api/admin/clients/search?${queryParams}`, { headers: { 'Authorization': `Bearer ${adminToken}` } });
                if (!response.ok) throw new Error((await response.json()).error || 'Search failed');
                const clients = await response.json();
                populateClientsTable(clients);
                showMessage(listAllClientsMessageDiv, `Found ${clients.length} client(s).`, 'info');
            } catch (error) {
                showMessage(listAllClientsMessageDiv, error.message, 'error');
            }
        });

        clearSearchClientsBtn.addEventListener('click', () => {
            searchClientsForm.reset();
            fetchAllClients();
            showMessage(listAllClientsMessageDiv, '', 'info');
        });
        
        allClientsTableBody.addEventListener('click', async function(event) {
            const target = event.target.closest('.action-btn');
            if (!target) return;

            const clientId = target.dataset.id;
            let currentAssignmentType = null;

            if (target.classList.contains('edit-client-btn')) {
                openEditClientModal(clientId);
            } else if (target.classList.contains('toggle-active-btn')) {
                const newStatus = !(target.dataset.current_active === 'true');
                if (confirm(`Sure you want to ${newStatus ? 'activate' : 'deactivate'} client account?`)) {
                    try {
                        const response = await fetch(`/api/admin/clients/${clientId}/status`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` },
                            body: JSON.stringify({ is_active: newStatus })
                        });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.error);
                        showMessage(listAllClientsMessageDiv, result.message, 'success');
                        fetchAllClients();
                    } catch (error) { showMessage(listAllClientsMessageDiv, error.message, 'error'); }
                }
            } else if (target.classList.contains('assign-nutri-btn')) {
                currentAssignmentType = 'nutritionist';
                assignStaffModalTitle.textContent = `Assign Nutritionist to Client ID: ${clientId}`;
                await populateStaffDropdown('nutritionist', clientId, currentAssignmentType); // Pass clientId and type
                assignStaffModal.style.display = 'block';
            } else if (target.classList.contains('link-exec-btn')) {
                currentAssignmentType = 'executive';
                assignStaffModalTitle.textContent = `Link Executive to Client ID: ${clientId}`;
                await populateStaffDropdown('executive', clientId, currentAssignmentType); // Pass clientId and type
                assignStaffModal.style.display = 'block';
            } else if (target.classList.contains('view-food-plan-btn')) {
                openClientFoodPlanModal(clientId);
            } else if (target.classList.contains('view-biodata-btn')) {
                openViewClientBiodataModal(clientId);
            } else if (target.classList.contains('view-medical-history-btn')) {
                openViewClientMedicalHistoryModal(clientId);
            } else if (target.classList.contains('view-blood-tests-btn')) {
                openViewClientBloodTestsModal(clientId);
            }
        });
        
        async function populateStaffDropdown(role, clientId, assignmentType) { // Added clientId and assignmentType
            staffDropdown.innerHTML = '<option value="">Select Staff...</option>';
            const endpoint = role === 'nutritionist' ? '/api/admin/nutritionists' : '/api/admin/executives';
            try {
                const response = await fetch(endpoint, { headers: { 'Authorization': `Bearer ${adminToken}` } });
                if (!response.ok) throw new Error('Failed to fetch staff');
                const staffList = await response.json();
                const activeStaff = staffList.filter(s => s.is_active);
                activeStaff.forEach(staff => {
                    staffDropdown.innerHTML += `<option value="${staff.user_id}">${staff.first_name} ${staff.last_name} (ID: ${staff.user_id})</option>`;
                });
                // Store clientId and assignmentType for the confirm button
                confirmStaffAssignmentBtn.dataset.clientId = clientId;
                confirmStaffAssignmentBtn.dataset.assignmentType = assignmentType;
            } catch (error) {
                showMessage(assignStaffMessageDiv, error.message, 'error');
            }
        }

        confirmStaffAssignmentBtn.addEventListener('click', async function() {
            const clientId = this.dataset.clientId; // Retrieve from button's dataset
            const assignmentType = this.dataset.assignmentType; // Retrieve from button's dataset
            const selectedStaffId = staffDropdown.value;

            if (!clientId || !assignmentType || !selectedStaffId) {
                showMessage(assignStaffMessageDiv, 'Error: Client ID, assignment type, or staff selection missing.', 'error');
                return;
            }
            showMessage(assignStaffMessageDiv, 'Processing...', 'info');
            try {
                const response = await fetch(`/api/admin/clients/${clientId}/assign-${assignmentType}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` },
                    body: JSON.stringify({ staff_id: selectedStaffId })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                showMessage(assignStaffMessageDiv, result.message, 'success');
                fetchAllClients();
                setTimeout(() => { assignStaffModal.style.display = "none"; }, 1500);
            } catch (error) {
                showMessage(assignStaffMessageDiv, error.message, 'error');
            }
        });


        async function openEditClientModal(clientId) {
            currentEditingClientId = clientId;
            showMessage(editClientMessageDiv, 'Loading...', 'info');
            editClientModal.style.display = 'block';
            try {
                const response = await fetch(`/api/admin/clients/${clientId}/details`, { headers: { 'Authorization': `Bearer ${adminToken}` } });
                if (!response.ok) throw new Error((await response.json()).error || 'Failed to fetch');
                const client = await response.json();
                document.getElementById('edit_client_id').value = client.client_id;
                document.getElementById('edit_client_first_name').value = client.first_name;
                document.getElementById('edit_client_last_name').value = client.last_name;
                document.getElementById('edit_client_email').value = client.email;
                document.getElementById('edit_client_mobile_number').value = client.mobile_number;
                showMessage(editClientMessageDiv, '', 'info');
            } catch (error) {
                showMessage(editClientMessageDiv, error.message, 'error');
            }
        }

        editClientForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const clientId = document.getElementById('edit_client_id').value;
            const data = {
                first_name: document.getElementById('edit_client_first_name').value,
                last_name: document.getElementById('edit_client_last_name').value,
                email: document.getElementById('edit_client_email').value,
                mobile_number: document.getElementById('edit_client_mobile_number').value
            };
            showMessage(editClientMessageDiv, 'Saving...', 'info');
            try {
                const response = await fetch(`/api/admin/clients/${clientId}/details`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                showMessage(editClientMessageDiv, result.message, 'success');
                fetchAllClients();
                setTimeout(() => { editClientModal.style.display = 'none'; }, 1500);
            } catch (error) {
                showMessage(editClientMessageDiv, error.message, 'error');
            }
        });

        // --- General Food Recommendations ---
        async function initializeGeneralRecsEditor() {
            try {
                if (generalRecommendationsEditor) { // Destroy existing editor if any
                    await generalRecommendationsEditor.destroy();
                    generalRecommendationsEditor = null;
                }
                generalRecommendationsEditor = await ClassicEditor.create(document.querySelector('#adminGeneralRecommendationsText'));
                // Fetch existing recommendations
                const response = await fetch('/api/general-food-recommendations', { headers: { 'Authorization': `Bearer ${adminToken}` } }); // Admin might need token for GET too
                if (response.ok) {
                    const data = await response.json();
                    if (data.recommendations) generalRecommendationsEditor.setData(data.recommendations);
                } else { console.warn('Could not fetch existing general recommendations.'); }
            } catch (error) {
                console.error('Error initializing CKEditor for general recommendations:', error);
                showMessage(adminGeneralRecsMessageDiv, 'Failed to load editor.', 'error');
            }
        }

        generalRecommendationsForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const recommendations_text = generalRecommendationsEditor.getData();
            showMessage(adminGeneralRecsMessageDiv, 'Saving...', 'info');
            try {
                const response = await fetch('/api/admin/general-food-recommendations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` },
                    body: JSON.stringify({ recommendations_text })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                showMessage(adminGeneralRecsMessageDiv, result.message, 'success');
            } catch (error) {
                showMessage(adminGeneralRecsMessageDiv, error.message, 'error');
            }
        });

        // --- Client Food Plan Modal (Admin) ---
        function generateTimeSlots() {
            const slots = [];
            for (let i = 0; i < 24; i++) {
                const hour = (6 + i) % 24; // Start from 6 AM
                slots.push({
                    formValue: `${String(hour).padStart(2, '0')}:00`,
                    displayValue: `${String(hour % 12 || 12).padStart(2, '0')}:00 ${hour >= 12 ? 'PM' : 'AM'}`
                });
            }
            return slots;
        }

        async function openClientFoodPlanModal(clientId) {
            document.getElementById('editing_client_id_for_food_plan').value = clientId;
            clientFoodPlanModalTitle.textContent = `Food Plan for Client ID: ${clientId}`;
            showMessage(clientFoodPlanMessageDiv, 'Loading food plan...', 'info');
            clientFoodPlanModal.style.display = 'block';

            // Clear previous hourly plan and destroy old editors if any
            clientFoodPlanHourlyTableBody.innerHTML = '';
            for (const editorId in clientFoodPlanEditors) {
                if (clientFoodPlanEditors[editorId] && clientFoodPlanEditors[editorId].destroy) {
                    await clientFoodPlanEditors[editorId].destroy().catch(err => console.error("Error destroying editor:", err));
                }
            }
            clientFoodPlanEditors = {}; // Reset editors object

            const timeSlots = generateTimeSlots();
            timeSlots.forEach(slot => {
                const row = clientFoodPlanHourlyTableBody.insertRow();
                const timeKey = slot.formValue.replace(':', '');
                row.innerHTML = `
                    <td class="time-column">${slot.displayValue}</td>
                    <td><textarea id="fp_present_intake_${timeKey}" name="present_intake_${timeKey}"></textarea></td>
                    <td><textarea id="fp_proposed_structure_${timeKey}" name="proposed_structure_${timeKey}"></textarea></td>
                    <td><textarea id="fp_additional_points_${timeKey}" name="additional_points_${timeKey}"></textarea></td>`;
            });
            
            // Initialize CKEditor only for personal recommendations
            if (clientFoodPlanPersonalRecommendationsTextarea && !clientFoodPlanEditors[clientFoodPlanPersonalRecommendationsTextarea.id]) {
                try {
                    clientFoodPlanEditors[clientFoodPlanPersonalRecommendationsTextarea.id] = await ClassicEditor.create(clientFoodPlanPersonalRecommendationsTextarea);
                } catch (error) { console.error(`Error creating CKEditor for personal recs:`, error); }
            }

            // Fetch general admin recommendations (read-only display)
            try {
                const genRecResponse = await fetch('/api/general-food-recommendations', { headers: { 'Authorization': `Bearer ${adminToken}` } });
                if (genRecResponse.ok) {
                    const genRecData = await genRecResponse.json();
                    clientFoodPlanGeneralAdminRecommendationsDisplay.innerHTML = genRecData.recommendations || 'N/A';
                } else { clientFoodPlanGeneralAdminRecommendationsDisplay.innerHTML = 'Error loading general recs.'; }
            } catch (error) { clientFoodPlanGeneralAdminRecommendationsDisplay.innerHTML = 'Error loading general recs.'; }

            // Fetch client's latest food plan
            try {
                const response = await fetch(`/api/admin/clients/${clientId}/food-plan/latest`, { headers: { 'Authorization': `Bearer ${adminToken}` } });
                const planData = await response.json();
                if (!response.ok) throw new Error(planData.error || 'Failed to load plan');

                if (planData.message && planData.message.includes("No food plan found")) {
                    showMessage(clientFoodPlanMessageDiv, 'No existing food plan. Create a new one.', 'info');
                    if (clientFoodPlanEditors[clientFoodPlanPersonalRecommendationsTextarea.id]) {
                        clientFoodPlanEditors[clientFoodPlanPersonalRecommendationsTextarea.id].setData('');
                    }
                } else {
                    if (clientFoodPlanEditors[clientFoodPlanPersonalRecommendationsTextarea.id]) {
                        clientFoodPlanEditors[clientFoodPlanPersonalRecommendationsTextarea.id].setData(planData.additional_personal_recommendations || '');
                    }
                    planData.hourly_details.forEach(detail => {
                        const timeKey = detail.time_slot.replace(':', '');
                        const presentIntakeTextarea = document.getElementById(`fp_present_intake_${timeKey}`);
                        if (presentIntakeTextarea) presentIntakeTextarea.value = detail.present_intake || '';
                        const proposedStructureTextarea = document.getElementById(`fp_proposed_structure_${timeKey}`);
                        if (proposedStructureTextarea) proposedStructureTextarea.value = detail.proposed_structure || '';
                        const additionalPointsTextarea = document.getElementById(`fp_additional_points_${timeKey}`);
                        if (additionalPointsTextarea) additionalPointsTextarea.value = detail.additional_points || '';
                    });
                    showMessage(clientFoodPlanMessageDiv, 'Client food plan loaded.', 'info');
                }
            } catch (error) {
                showMessage(clientFoodPlanMessageDiv, error.message, 'error');
                if (clientFoodPlanEditors[clientFoodPlanPersonalRecommendationsTextarea.id]) {
                     clientFoodPlanEditors[clientFoodPlanPersonalRecommendationsTextarea.id].setData('');
                }
            }
        }

        clientFoodPlanEditForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const clientId = document.getElementById('editing_client_id_for_food_plan').value;
            const dataToSend = { hourly_plan: {} };
            
            if (clientFoodPlanEditors[clientFoodPlanPersonalRecommendationsTextarea.id]) {
                dataToSend.additional_personal_recommendations = clientFoodPlanEditors[clientFoodPlanPersonalRecommendationsTextarea.id].getData();
            } else {
                dataToSend.additional_personal_recommendations = clientFoodPlanPersonalRecommendationsTextarea.value; // Fallback if editor failed
            }

            const timeSlots = generateTimeSlots();
            timeSlots.forEach(slot => {
                const timeKeyForBackend = slot.formValue;
                const timeKeyForEditorId = slot.formValue.replace(':', '');
                dataToSend.hourly_plan[timeKeyForBackend] = {
                    present_intake: document.getElementById(`fp_present_intake_${timeKeyForEditorId}`)?.value || null,
                    proposed_structure: document.getElementById(`fp_proposed_structure_${timeKeyForEditorId}`)?.value || null,
                    additional_points: document.getElementById(`fp_additional_points_${timeKeyForEditorId}`)?.value || null
                };
            });
            showMessage(clientFoodPlanMessageDiv, 'Saving...', 'info');
            try {
                const response = await fetch(`/api/admin/clients/${clientId}/food-plan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` },
                    body: JSON.stringify(dataToSend)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Failed to save');
                showMessage(clientFoodPlanMessageDiv, result.message, 'success');
                setTimeout(() => {
                    clientFoodPlanModal.style.display = 'none';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 2000);
            } catch (error) {
                showMessage(clientFoodPlanMessageDiv, error.message, 'error');
            }
        });

        // --- View Client Medical History by Admin ---
        async function openViewClientMedicalHistoryModal(clientId) {
            viewClientMedicalHistoryModalTitle.textContent = `Medical History for Client ID: ${clientId}`;
            showMessage(viewClientMedicalHistoryMessageDiv, 'Loading...', 'info');
            viewClientMedicalHistoryModal.style.display = 'block';
            viewSelfMedicalHistoryDiv.innerHTML = '';
            viewFamilyMedicalHistoryDiv.innerHTML = '';
            viewClientMedicationsTableBody.innerHTML = '';
            try {
                const response = await fetch(`/api/admin/clients/${clientId}/medical-history/latest`, { headers: { 'Authorization': `Bearer ${adminToken}` } });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to fetch');
                if (data.message && data.message.includes("No medical history found")) {
                    showMessage(viewClientMedicalHistoryMessageDiv, data.message, 'info');
                } else {
                    viewSelfMedicalHistoryDiv.innerHTML = data.self_medical_history ? data.self_medical_history.replace(/\n/g, '<br>') : 'N/A';
                    viewFamilyMedicalHistoryDiv.innerHTML = data.family_medical_history ? data.family_medical_history.replace(/\n/g, '<br>') : 'N/A';
                    if (data.medications && data.medications.length > 0) {
                        data.medications.forEach(med => {
                            const row = viewClientMedicationsTableBody.insertRow();
                            row.innerHTML = `<td>${med.diagnosis||'N/A'}</td><td>${med.medicine_name||'N/A'}</td><td>${med.power||'N/A'}</td><td>${med.timing||'N/A'}</td><td>${med.since_when||'N/A'}</td>`;
                        });
                    } else {
                        viewClientMedicationsTableBody.innerHTML = '<tr><td colspan="5">No medications listed.</td></tr>';
                    }
                    showMessage(viewClientMedicalHistoryMessageDiv, 'Loaded.', 'info');
                }
            } catch (error) {
                showMessage(viewClientMedicalHistoryMessageDiv, error.message, 'error');
            }
        }
        
        // --- View Client Biodata (Personal Details) by Admin ---
        async function openViewClientBiodataModal(clientId) {
            viewClientBiodataModalTitle.textContent = `Personal Details for Client ID: ${clientId}`;
            showMessage(viewClientBiodataMessageDiv, 'Loading...', 'info');
            viewClientBiodataModal.style.display = 'block';
            viewClientBiodataContentDiv.innerHTML = '';
            try {
                const response = await fetch(`/api/admin/clients/${clientId}/personal-details`, { headers: { 'Authorization': `Bearer ${adminToken}` } });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Failed to fetch');
                let contentHtml = '';
                for (const key in data) {
                    if (data.hasOwnProperty(key)) {
                        let value = data[key];
                        const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        if (key.includes('date') && value) value = new Date(value).toLocaleDateString();
                        else if (typeof value === 'boolean') value = value ? 'Yes' : 'No';
                        else if (value === null || value === undefined || value === '') value = 'N/A';
                        contentHtml += `<div class="data-pair"><span class="data-label">${label}:</span><span class="data-value">${value}</span></div>`;
                    }
                }
                viewClientBiodataContentDiv.innerHTML = contentHtml;
                showMessage(viewClientBiodataMessageDiv, 'Loaded.', 'info');
            } catch (error) {
                showMessage(viewClientBiodataMessageDiv, error.message, 'error');
            }
        }

        // Define the test structure for the admin view (similar to client-blood-tests-form.html)
        const bloodTestDefinitions = {
            cbc: {
                title: 'CBC',
                tests: [
                    { key: 'hemoglobin', name: 'HEMOGLOBIN', range: 'M= 13.5-18 GM/DL; F=12-16.8 GM/DL' },
                    { key: 'total_wbc', name: 'TOTAL WBC', range: '4000-11000 /CMM' },
                    { key: 'total_rbc', name: 'TOTAL RBC', range: '4.5-6 MIL/CMM' },
                    { key: 'platelet', name: 'PLATELET', range: '150000-450000 /CMM' },
                    { key: 'pcv', name: 'PCV', range: 'M - 40 TO 50 , F - 36 TO 46' },
                    { key: 'mcv', name: 'MCV', range: '83 TO 101 FL' },
                    { key: 'mch', name: 'MCH', range: '27-32 PG' },
                    { key: 'mchc', name: 'MCHC', range: '32-36% G/DL' },
                    { key: 'rdw', name: 'RDW', range: '11.5-14%' },
                    { key: 'eosinophils', name: 'EOSINOPHILS', range: '0 - 6' }
                ]
            },
            diabetes: {
                title: 'DIABETES INDICATOR',
                tests: [
                    { key: 'fasting_glucose', name: 'FASTING BLOOD GLUCOSE', range: '70-110 MG/DL' },
                    { key: 'fasting_insulin', name: 'FASTING INSULIN', range: '2.6-37.6 MICRO U/ML' },
                    { key: 'hba1c_hplc', name: 'HbA 1 C (HPLC)', range: '&lt;/= 6.0 % OF TOTAL Hb' },
                    { key: 'hba1c_ifcc', name: 'HbA 1 C (IFCC) (HPLC)', range: '&lt;/= 42MMOL/MOL' },
                    { key: 'avg_plasma_glucose', name: 'AVG. PLASMA GLUCOSE OF LAST 3 MONTHS (CALC)', range: '80-140 MG/DL' }
                ]
            },
            kft: {
                title: 'KIDNEY FUNCTION TEST',
                tests: [
                    { key: 'uric_acid', name: 'URIC ACID', range: 'M-3.5 TO 7.2, F - 2.6 TO 6' },
                    { key: 'bun', name: 'BLOOD UREA NITROGEN ( BUN)', range: 'MG/DL 7.9 TO 20' },
                    { key: 's_creatinine', name: 'S. CREATININE', range: 'M= 0.4-1.4 MG/DL; F= 0.2-1.2 MG/DL' },
                    { key: 'bun_creatinine_ratio', name: 'BUN / S CREATININE RATIO', range: '9.1 TO 23.1' },
                    { key: 'sodium', name: 'SODIUM', range: 'MMOL/L 136-146' },
                    { key: 'chloride', name: 'CHLORIDE', range: 'MMOL/L 98 - 106' },
                    { key: 'egfr', name: 'ESTIMATED GLOMERULAR FILTERATION RATE', range: '&gt;90, 60-90,45-59,30 -44, 15,29' }
                ]
            },
            // Add other sections (lft, lipid, inflammation, vitamind3, vitaminb12, testosterone, thyroid)
            // in the same format as above, copying their definitions from client-blood-tests-form.html
            // For brevity, I'm omitting them here, but you should include them all.
            // Example for one more:
            thyroid: {
                title: 'THYROID FUNCTION TEST',
                tests: [
                    { key: 't3', name: 'T3', range: 'NG/DL 60 TO 200' },
                    { key: 't4', name: 'T4', range: 'MUG/DL 4.5 TO 12' },
                    { key: 'tsh', name: 'TSH', range: 'MIU/ML  0.3 TO 5.5' }
                ]
            }
        };

        // --- View Client Blood Tests by Admin ---
        async function openViewClientBloodTestsModal(clientId) {
            viewClientBloodTestsModalTitle.textContent = `Blood Tests for Client ID: ${clientId}`;
            showMessage(viewClientBloodTestsMessageDiv, 'Loading blood tests...', 'info');
            viewClientBloodTestsModal.style.display = 'block';
            viewClientBloodTestReportDatesDiv.innerHTML = '';
            viewClientBloodTestsTableContainer.innerHTML = ''; // Clear previous table

            try {
                const response = await fetch(`/api/admin/clients/${clientId}/blood-tests/latest`, { // Assuming this endpoint exists
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch client blood tests.');
                }

                if (data.message && data.message.includes("No blood test reports found")) {
                    showMessage(viewClientBloodTestsMessageDiv, 'No blood test reports submitted by this client.', 'info');
                    return;
                }
                
                // Display report dates
                let reportDatesHtml = 'Report Dates: ';
                let hasDates = false;
                for (let i = 1; i <= 5; i++) {
                    if (data[`report_date_${i}`]) {
                        reportDatesHtml += `D${i}: ${new Date(data[`report_date_${i}`]).toLocaleDateString()} | `;
                        hasDates = true;
                    }
                }
                viewClientBloodTestReportDatesDiv.innerHTML = hasDates ? reportDatesHtml.slice(0, -3) : 'No report dates submitted.';

                // Create table header
                const tableHeader = `
                    <div class="test-header-row">
                        <div>Test Name</div>
                        <div>Normal Range</div>
                        ${[1,2,3,4,5].map(i => `<div>Value D${i}</div>`).join('')}
                    </div>`;
                viewClientBloodTestsTableContainer.innerHTML = tableHeader;

                // Iterate through defined test sections and tests
                for (const sectionKey in bloodTestDefinitions) {
                    const section = bloodTestDefinitions[sectionKey];
                    
                    // Add section subheader (optional, if you want to group them visually like client form)
                    const sectionHeaderRow = document.createElement('div');
                    sectionHeaderRow.className = 'test-data-row'; // Can use same styling or a new one
                    sectionHeaderRow.innerHTML = `<div style="grid-column: 1 / -1; background-color: #e9ecef; font-weight: bold; padding: 8px;">${section.title}</div>`;
                    viewClientBloodTestsTableContainer.appendChild(sectionHeaderRow);

                    section.tests.forEach(testDef => {
                        const clientResult = data.results ? data.results.find(r => r.test_code === testDef.key) : null;
                        const row = document.createElement('div');
                        row.className = 'test-data-row';
                        row.innerHTML = `
                            <div class="test-name">${testDef.name}</div>
                            <div class="normal-range">${testDef.range || 'N/A'}</div> 
                            <div>${clientResult?.value_d1 || 'N/A'}</div>
                            <div>${clientResult?.value_d2 || 'N/A'}</div>
                            <div>${clientResult?.value_d3 || 'N/A'}</div>
                            <div>${clientResult?.value_d4 || 'N/A'}</div>
                            <div>${clientResult?.value_d5 || 'N/A'}</div>
                        `;
                        viewClientBloodTestsTableContainer.appendChild(row);
                    });
                }

                if (!data.results || data.results.length === 0) {
                     showMessage(viewClientBloodTestsMessageDiv, 'Report dates loaded, but no specific test values found. Displaying all possible tests.', 'info');
                } else { showMessage(viewClientBloodTestsMessageDiv, 'Blood tests loaded.', 'info'); }


            } catch (error) {
                console.error('Error fetching client blood tests for admin view:', error);
                showMessage(viewClientBloodTestsMessageDiv, error.message, 'error');
            }
        }


        // --- Modal Close Handlers ---
        function setupModalCloseButton(modalElement, closeButtonId) {
            const closeBtn = document.getElementById(closeButtonId);
            if (closeBtn) {
                closeBtn.onclick = () => { modalElement.style.display = "none"; };
            }
        }
        setupModalCloseButton(assignStaffModal, 'closeAssignStaffModalBtn');
        setupModalCloseButton(editClientModal, 'closeEditClientModalBtn');
        setupModalCloseButton(clientFoodPlanModal, 'closeClientFoodPlanModalBtn');
        setupModalCloseButton(viewClientMedicalHistoryModal, 'closeViewClientMedicalHistoryModalBtn');
        setupModalCloseButton(viewClientBiodataModal, 'closeViewClientBiodataModalBtn');
        setupModalCloseButton(viewClientBloodTestsModal, 'closeViewClientBloodTestsModalBtn');


        window.onclick = function(event) {
            if (event.target == assignStaffModal) assignStaffModal.style.display = "none";
            if (event.target == editClientModal) editClientModal.style.display = "none";
            if (event.target == clientFoodPlanModal) clientFoodPlanModal.style.display = "none";
            if (event.target == viewClientMedicalHistoryModal) viewClientMedicalHistoryModal.style.display = "none";
            if (event.target == viewClientBiodataModal) viewClientBiodataModal.style.display = "none";
            if (event.target == viewClientBloodTestsModal) viewClientBloodTestsModal.style.display = "none";
        };
        
        // --- Navbar Link Smooth Scroll ---
        document.querySelectorAll('.navbar-links a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                const targetElement = document.querySelector(targetId);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // --- Logout ---
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            window.location.href = '/admin-login.html';
        });

        // --- Initial Data Fetch ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchNutritionists();
            fetchExecutives();
            fetchAllClients();
            initializeGeneralRecsEditor();
        });
    </script>
</body>
</html>
